
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>meerqat.train.trainer &#8212; meerqat v3.0.0-alpha documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">

  
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/meerqat/train/trainer';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fas fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">meerqat v3.0.0-alpha documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fas fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <h1>Source code for meerqat.train.trainer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main training script based on transformers. Also holds Trainer subclasses.</span>

<span class="sd">Usage: trainer.py &lt;config&gt;</span>

<span class="sd">Positional arguments:</span>
<span class="sd">    &lt;config&gt;    Path to the JSON configuration file (passed as kwargs)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">humanize</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">set_detect_anomaly</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.dataset</span> <span class="kn">import</span> <span class="n">IterableDataset</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">RandomSampler</span>
<span class="kn">import</span> <span class="nn">torch.distributed</span> <span class="k">as</span> <span class="nn">dist</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">trainer_callback</span><span class="p">,</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">t_logging</span>
<span class="kn">from</span> <span class="nn">transformers.trainer_callback</span> <span class="kn">import</span> <span class="n">TrainerState</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_from_disk</span><span class="p">,</span> <span class="n">load_metric</span>
<span class="kn">from</span> <span class="nn">transformers.deepspeed</span> <span class="kn">import</span> <span class="n">deepspeed_init</span>
<span class="kn">from</span> <span class="nn">transformers.file_utils</span> <span class="kn">import</span> <span class="n">WEIGHTS_NAME</span><span class="p">,</span> <span class="n">is_torch_tpu_available</span>
<span class="kn">from</span> <span class="nn">transformers.trainer_pt_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IterableDatasetShard</span><span class="p">,</span>
    <span class="n">find_batch_size</span><span class="p">,</span>
    <span class="n">nested_concat</span><span class="p">,</span>
    <span class="n">nested_numpify</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">transformers.trainer_utils</span> <span class="kn">import</span> <span class="n">EvalLoopOutput</span><span class="p">,</span> <span class="n">denumpify_detensorize</span>
<span class="k">if</span> <span class="n">is_torch_tpu_available</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">torch_xla.distributed.parallel_loader</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="kn">import</span> <span class="nn">ranx</span>

<span class="kn">from</span> <span class="nn">..data.loading</span> <span class="kn">import</span> <span class="n">load_pretrained_in_kwargs</span>
<span class="kn">from</span> <span class="nn">..models.qa</span> <span class="kn">import</span> <span class="n">get_best_spans</span><span class="p">,</span> <span class="n">format_predictions_for_squad</span>
<span class="kn">from</span> <span class="nn">..models.utils</span> <span class="kn">import</span> <span class="n">debug_shape</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">metrics</span> <span class="k">as</span> <span class="n">metric_functions</span>


<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="max_memory_usage"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.max_memory_usage">[docs]</a><span class="k">def</span> <span class="nf">max_memory_usage</span><span class="p">(</span><span class="n">human</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets max_memory_allocated per GPU.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    human: bool, optional</span>
<span class="sd">        make memory usage human-readable.</span>
<span class="sd">        Defaults to machine-readable.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    logs: dict</span>
<span class="sd">        {GPU device: max_memory_allocated}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()):</span>
        <span class="n">device</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">max_memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">human</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">humanize</span><span class="o">.</span><span class="n">naturalsize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">gnu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;max_memory_</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">logs</span></div>


<div class="viewcode-block" id="MeerqatTrainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MeerqatTrainer">[docs]</a><span class="k">class</span> <span class="nc">MeerqatTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all trainers. Provides only minimal changes to Trainer</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args, **kwargs: </span>
<span class="sd">        additionnal arguments are passed to Trainer.</span>
<span class="sd">    model: nn.Module</span>
<span class="sd">        see Trainer</span>
<span class="sd">    freeze: str, optional</span>
<span class="sd">        represents a regex used to match the model parameters to freeze</span>
<span class="sd">        (i.e. set ``requires_grad = False``).</span>
<span class="sd">        Defaults to None (keep model fully-trainable)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">freeze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">freeze</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">freeze</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_file_name</span> <span class="o">=</span> <span class="s2">&quot;predictions.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_file_name</span> <span class="o">=</span> <span class="s2">&quot;metrics.json&quot;</span>
    
<div class="viewcode-block" id="MeerqatTrainer.freeze"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MeerqatTrainer.freeze">[docs]</a>    <span class="k">def</span> <span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
        <span class="n">total</span><span class="p">,</span> <span class="n">frozen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Model parameters:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;Name&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">#Trainable</span><span class="se">\t</span><span class="s2">#Total&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="n">numel</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">frozen</span> <span class="o">+=</span> <span class="n">numel</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">numel</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="p">(</span><span class="n">numel</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,d</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">numel</span><span class="si">:</span><span class="s2">,d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Froze </span><span class="si">{</span><span class="n">frozen</span><span class="si">:</span><span class="s2">,d</span><span class="si">}</span><span class="s2"> parameters out of </span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">,d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>
        
<div class="viewcode-block" id="MeerqatTrainer.log"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MeerqatTrainer.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Adds memory usage to the logs&quot;&quot;&quot;</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">max_memory_usage</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MeerqatTrainer.write_predictions"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MeerqatTrainer.write_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">write_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="MeerqatTrainer.write_metrics"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MeerqatTrainer.write_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">write_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="QuestionAnsweringTrainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.QuestionAnsweringTrainer">[docs]</a><span class="k">class</span> <span class="nc">QuestionAnsweringTrainer</span><span class="p">(</span><span class="n">MeerqatTrainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for Question Answering trainers. Should work for both IR and RC.</span>
<span class="sd">    Overrides some methods because we need to create the batch of questions and passages on-the-fly</span>
<span class="sd">    Because the inputs should be shaped like (N * M, L), where:</span>
<span class="sd">        * N - number of distinct questions</span>
<span class="sd">        * M - number of passages per question in a batch</span>
<span class="sd">        * L - sequence length</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args, **kwargs: </span>
<span class="sd">        additional arguments are passed to MeerqatTrainer</span>
<span class="sd">    kb: str, optional</span>
<span class="sd">        path towards the knowledge base (Dataset) used to get the passages</span>
<span class="sd">        Optional because not needed in ICTTrainer, mandatory for the other trainers.</span>
<span class="sd">    M: int, optional</span>
<span class="sd">        Number of passages (relevant or irrelevant) per question in a batch</span>
<span class="sd">        Defaults to 24</span>
<span class="sd">    n_relevant_passages: int, optional</span>
<span class="sd">        Defaults to 1</span>
<span class="sd">    search_key: str, optional</span>
<span class="sd">        This column in the dataset suffixed by &#39;_indices&#39; and &#39;_scores&#39; should hold the result of information retrieval</span>
<span class="sd">        used during evaluation (e.g. the output of ir.search)</span>
<span class="sd">        Suffixed by &quot;_provenance_indices&quot; and &quot;_irrelevant_indices&quot; it should hold:</span>
<span class="sd">            1. the union of relevant search and provenance_indices</span>
<span class="sd">            2. irrelevant results from the search</span>
<span class="sd">        used during training (according to M and n_relevant_passages)</span>
<span class="sd">        Defaults to &#39;search&#39;</span>
<span class="sd">    tokenization_kwargs: dict, optional</span>
<span class="sd">        To be passed to self.tokenizer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">kb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">n_relevant_passages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">search_key</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">tokenization_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span>
        <span class="k">assert</span> <span class="n">n_relevant_passages</span> <span class="o">&lt;=</span> <span class="n">M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span> <span class="o">=</span> <span class="n">n_relevant_passages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_key</span> <span class="o">=</span> <span class="n">search_key</span>
        <span class="n">default_tokenization_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tokenization_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tokenization_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">default_tokenization_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span> <span class="o">=</span> <span class="n">default_tokenization_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span>

        <span class="c1"># we need those ‘un-used’ columns to actually create the batch the model will use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">remove_unused_columns</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting args.remove_unused_columns to False&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">remove_unused_columns</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="QuestionAnsweringTrainer.get_training_passages"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.QuestionAnsweringTrainer.get_training_passages">[docs]</a>    <span class="k">def</span> <span class="nf">get_training_passages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item: dict</span>
<span class="sd">            item (e.g. question) from self.train_dataset or self.eval_dataset.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        relevant_passages, irrelevant_passages: list[dict]</span>
<span class="sd">            List of relevant and irrelevant passages selected from self.kb</span>
<span class="sd">            according to:</span>
<span class="sd">                - self.n_relevant_passages</span>
<span class="sd">                - self.M</span>
<span class="sd">                - self.search_key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">relevant_passages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_relevant_indices</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">search_key</span><span class="o">+</span><span class="s2">&quot;_provenance_indices&quot;</span><span class="p">]</span>
        <span class="n">n_relevant</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_relevant_indices</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_relevant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">relevant_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_relevant_indices</span><span class="p">,</span> <span class="n">n_relevant</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">relevant_passages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">relevant_indices</span><span class="p">)</span>
        <span class="n">irrelevant_passages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_irrelevant_indices</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">search_key</span><span class="o">+</span><span class="s2">&quot;_irrelevant_indices&quot;</span><span class="p">]</span>
        <span class="n">n_irrelevant</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_irrelevant_indices</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_irrelevant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">irrelevant_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_irrelevant_indices</span><span class="p">,</span> <span class="n">n_irrelevant</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">irrelevant_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">irrelevant_passages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">irrelevant_indices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n_relevant</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t find any passage for question </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relevant_passages</span><span class="p">,</span> <span class="n">irrelevant_passages</span></div></div>


<div class="viewcode-block" id="DPRBiEncoderTrainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.DPRBiEncoderTrainer">[docs]</a><span class="k">class</span> <span class="nc">DPRBiEncoderTrainer</span><span class="p">(</span><span class="n">QuestionAnsweringTrainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model should be a BiEncoder (or subclass). </span>
<span class="sd">    Loss is computed in ``compute_loss`` (and not in model, like usually in Trainer).</span>
<span class="sd">    </span>
<span class="sd">    The training objective is to minimize the negative log-likelihood of the similarities (dot product)</span>
<span class="sd">    between the questions and the passages embeddings, as described in [1]_.</span>
<span class="sd">    Therefore there should be only one relevant passage per question (i.e. ``self.n_relevant_passages == 1``)</span>
<span class="sd">    This objective is also used in subclasses for visual questions and visual passages.</span>
<span class="sd">    </span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Vladimir Karpukhin, Barlas Oguz, Sewon Min, Patrick Lewis, Ledell Wu, Sergey Edunov, Danqi Chen, Wen-tau Yih. </span>
<span class="sd">       Dense Passage Retrieval for Open-Domain Question Answering. </span>
<span class="sd">       Proceedings of the 2020 Conference on Empirical Methods in Natural Language Processing (EMNLP), pages 6769–6781, 2020.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fct</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span> <span class="o">==</span> <span class="mi">1</span>

<div class="viewcode-block" id="DPRBiEncoderTrainer.collate_fn"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.DPRBiEncoderTrainer.collate_fn">[docs]</a>    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collate batch so that each question is associate with n_relevant_passages and M-n irrelevant ones.</span>
<span class="sd">        Also tokenizes input strings</span>

<span class="sd">            * N - number of questions in a batch</span>
<span class="sd">            * M - number of passages per questions</span>
<span class="sd">            * d - dimension of the model/embeddings</span>

<span class="sd">        Returns (a dict of)</span>
<span class="sd">        -------------------</span>
<span class="sd">        question_inputs: dict[torch.LongTensor]</span>
<span class="sd">            input_ids: torch.LongTensor</span>
<span class="sd">                shape (N, L)</span>
<span class="sd">            **kwargs: </span>
<span class="sd">                more tensors depending on the tokenizer, e.g. attention_mask</span>
<span class="sd">        context_inputs: dict[torch.LongTensor]</span>
<span class="sd">            input_ids: torch.LongTensor</span>
<span class="sd">                shape (N*M, L)</span>
<span class="sd">                The first N rows correspond to the relevant contexts for the N questions</span>
<span class="sd">                The rest N*(M-1) rows are irrelevant contexts for all questions.</span>
<span class="sd">            **kwargs: </span>
<span class="sd">                idem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_irrelevant_passages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span>
        <span class="n">questions</span><span class="p">,</span> <span class="n">relevant_passages</span><span class="p">,</span> <span class="n">irrelevant_passages</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">relevant_passage</span><span class="p">,</span> <span class="n">irrelevant_passage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_training_passages</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">relevant_passage</span><span class="p">,</span> <span class="n">irrelevant_passage</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">relevant_passage</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>  <span class="n">irrelevant_passage</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_passage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">relevant_passage</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fct</span><span class="o">.</span><span class="n">ignore_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_irrelevant_passages</span><span class="p">:</span>
                <span class="n">irrelevant_passage</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n_irrelevant_passages</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)))</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">])</span>
            <span class="n">relevant_passages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relevant_passage</span><span class="p">)</span>
            <span class="n">irrelevant_passages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)</span>

        <span class="n">question_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="n">context_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">relevant_passages</span> <span class="o">+</span> <span class="n">irrelevant_passages</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">question_inputs</span><span class="o">=</span><span class="n">question_inputs</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span></div>

<div class="viewcode-block" id="DPRBiEncoderTrainer.compute_loss"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.DPRBiEncoderTrainer.compute_loss">[docs]</a>    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates In-batch negatives schema loss and supports to run it in DDP mode by exchanging the representations across all the nodes.</span>
<span class="sd">        Adapted from https://github.com/facebookresearch/DPR/blob/main/train_dense_encoder.py</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This means that the whole representations of questions and contexts, and their similarity matrix, must fit on a single GPU.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_smoother</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="n">local_labels</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># (N, )</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Save past state if it exists</span>
        <span class="c1"># TODO: this needs to be fixed and made cleaner later.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">past_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_past</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">past_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">local_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># FIXME: this returns representations and not similarities</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_outputs</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">local_question_representations</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">question_pooler_output</span>  <span class="c1"># (N, d)</span>
        <span class="n">local_context_representations</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">context_pooler_output</span>  <span class="c1"># (N*M, d)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">world_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># copies local representations (in DPR they are moved to CPU but I got a RuntimeError: &quot;Tensors must be CUDA&quot;)</span>
            <span class="n">question_representations_to_send</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">local_question_representations</span><span class="p">)</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">local_question_representations</span><span class="p">)</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
            <span class="n">context_representations_to_send</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">local_context_representations</span><span class="p">)</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">local_context_representations</span><span class="p">)</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
            <span class="n">labels_to_send</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">local_labels</span><span class="p">)</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">local_labels</span><span class="p">)</span>

            <span class="c1"># gathers representations from other GPUs</span>
            <span class="n">question_representations_gatherer</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">question_representations_to_send</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">world_size</span><span class="p">)]</span>
            <span class="n">context_representations_gatherer</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">context_representations_to_send</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">world_size</span><span class="p">)]</span>
            <span class="n">labels_gatherer</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">labels_to_send</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">world_size</span><span class="p">)]</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">question_representations_gatherer</span><span class="p">,</span> <span class="n">question_representations_to_send</span><span class="p">)</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">context_representations_gatherer</span><span class="p">,</span> <span class="n">context_representations_to_send</span><span class="p">)</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">labels_gatherer</span><span class="p">,</span> <span class="n">labels_to_send</span><span class="p">)</span>
            
            <span class="c1"># keep local vector in the local_rank index (taken from DPR, to not loose the gradients?)</span>
            <span class="n">label_shift</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">global_question_representations</span><span class="p">,</span> <span class="n">global_context_representations</span><span class="p">,</span> <span class="n">global_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">gatherers</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">question_representations_gatherer</span><span class="p">,</span> <span class="n">context_representations_gatherer</span><span class="p">,</span> <span class="n">labels_gatherer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">received_question_representations</span><span class="p">,</span> <span class="n">received_context_representations</span><span class="p">,</span> <span class="n">received_labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gatherers</span><span class="p">):</span>
                <span class="c1"># receiving representations from other GPUs</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">:</span>
                    <span class="n">global_question_representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">received_question_representations</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_question_representations</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                    <span class="n">global_context_representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">received_context_representations</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_context_representations</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                    <span class="c1"># labels are defined at the batch-level so we need to shift them when concatening batches</span>
                    <span class="n">received_labels</span><span class="p">[</span><span class="n">received_labels</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fct</span><span class="o">.</span><span class="n">ignore_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">label_shift</span>
                    <span class="n">label_shift</span> <span class="o">+=</span> <span class="n">received_context_representations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># N*M</span>
                    <span class="n">global_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">received_labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">local_labels</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                <span class="c1"># keep local representation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">global_question_representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_question_representations</span><span class="p">)</span>
                    <span class="n">global_context_representations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_context_representations</span><span class="p">)</span>
                    <span class="c1"># labels are defined at the batch-level so we need to shift them when concatening batches</span>
                    <span class="n">local_labels</span><span class="p">[</span><span class="n">local_labels</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fct</span><span class="o">.</span><span class="n">ignore_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">label_shift</span>
                    <span class="n">label_shift</span> <span class="o">+=</span> <span class="n">local_context_representations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># N*M</span>
                    <span class="n">global_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_labels</span><span class="p">)</span>
            <span class="n">global_question_representations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">global_question_representations</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">global_context_representations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">global_context_representations</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">global_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">global_labels</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">global_question_representations</span> <span class="o">=</span> <span class="n">local_question_representations</span>  <span class="c1"># (N, d)</span>
            <span class="n">global_context_representations</span> <span class="o">=</span> <span class="n">local_context_representations</span>  <span class="c1"># (N*M, d)</span>
            <span class="n">global_labels</span> <span class="o">=</span> <span class="n">local_labels</span>  <span class="c1"># (N, )</span>

        <span class="c1"># compute similarity</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">global_question_representations</span> <span class="o">@</span> <span class="n">global_context_representations</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (N, N*M)</span>
        <span class="n">log_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fct</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span> <span class="n">global_labels</span><span class="p">)</span>

        <span class="c1"># beware of https://github.com/huggingface/transformers/blob/master/src/transformers/trainer.py#L2513 !!</span>
        <span class="c1"># do NOT return log_probs outside of a dict else it will get truncated</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">log_probs</span><span class="o">=</span><span class="n">log_probs</span><span class="p">))</span> <span class="k">if</span> <span class="n">return_outputs</span> <span class="k">else</span> <span class="n">loss</span></div></div>


<div class="viewcode-block" id="MMTrainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MMTrainer">[docs]</a><span class="k">class</span> <span class="nc">MMTrainer</span><span class="p">(</span><span class="n">DPRBiEncoderTrainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - loads pre-computed image features along with text </span>
<span class="sd">        - =&gt; overrides collate_fn</span>
<span class="sd">    </span>
<span class="sd">    ``model`` sohuld be a BiEncoder and its question_model and context_model </span>
<span class="sd">    should have a MMConfig config attribute to be able to infer:</span>
<span class="sd">        - n_faces: int</span>
<span class="sd">        - face_dim: int</span>
<span class="sd">        - bbox_dim: int</span>
<span class="sd">        - image_dims: dict[str, int]</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args, **kwargs: </span>
<span class="sd">        additional arguments are passed to DPRBiEncoderTrainer</span>
<span class="sd">    image_kb: str, optional</span>
<span class="sd">        Path to the KB that holds pre-computed image features</span>
<span class="sd">        Can be mapped from kb using kb[&#39;index&#39;]</span>
<span class="sd">        Optional to ease inheritance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">image_kb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_kb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_kb</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">image_kb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_kb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># image dimensions and model names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">question_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_faces</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">context_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_faces</span>
        
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">question_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">context_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_embeddings_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">question_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dims</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_embeddings_keys</span><span class="p">:</span>
            <span class="n">image_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">question_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;input_dim&quot;</span><span class="p">]</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">image_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">context_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">image_kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;input_dim&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_dims</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">face_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">question_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">face_kwargs</span><span class="p">[</span><span class="s1">&#39;face_dim&#39;</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">context_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">face_kwargs</span><span class="p">[</span><span class="s1">&#39;face_dim&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">question_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">face_kwargs</span><span class="p">[</span><span class="s1">&#39;bbox_dim&#39;</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">context_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">face_kwargs</span><span class="p">[</span><span class="s1">&#39;bbox_dim&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="MMTrainer.get_face_inputs"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MMTrainer.get_face_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">get_face_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats pre-computed face features in nice square tensors.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        face_inputs: dict[str, Tensor]</span>
<span class="sd">            {</span>
<span class="sd">               * face: Tensor(batch_size, self.n_faces, self.face_dim)</span>
<span class="sd">               * bbox: Tensor(batch_size, self.n_faces, self.bbox_dim)</span>
<span class="sd">               * attention_mask: Tensor(batch_size, self.n_faces)</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># trim or pad, and convert to tensor</span>
        <span class="n">face_embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_dim</span><span class="p">))</span>
        <span class="n">face_boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_dim</span><span class="p">))</span>
        <span class="c1"># 0=masked, 1=not masked</span>
        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;face&quot;</span><span class="p">:</span> <span class="n">face_embeddings</span><span class="p">,</span>
                <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">face_boxes</span><span class="p">,</span>
                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">face_embedding</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_embedding&quot;</span><span class="p">)</span>
            <span class="c1"># can happen in two cases: 1. no face detected; 2. padding passage</span>
            <span class="k">if</span> <span class="n">face_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># keep zero-padding/mask</span>
                <span class="k">continue</span>
            <span class="n">n_faces</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_faces</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_embedding</span><span class="p">))</span>
            <span class="n">face_embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">n_faces</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">face_embedding</span><span class="p">[:</span> <span class="n">n_faces</span><span class="p">])</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;face_box&quot;</span><span class="p">]</span>
            <span class="n">face_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">n_faces</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">bbox</span><span class="p">[:</span> <span class="n">n_faces</span><span class="p">])</span>
            <span class="n">attention_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">n_faces</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">face_inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;face&quot;</span><span class="p">:</span> <span class="n">face_embeddings</span><span class="p">,</span>
            <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">face_boxes</span><span class="p">,</span>
            <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">face_inputs</span></div>

<div class="viewcode-block" id="MMTrainer.get_image_inputs"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MMTrainer.get_image_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats pre-computed full-image features in nice square tensors.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        image_inputs: dict[str, dict[str,Tensor]]</span>
<span class="sd">            one key per image feature</span>
<span class="sd">            {</span>
<span class="sd">               * input: Tensor(batch_size, ?)</span>
<span class="sd">               * attention_mask: Tensor(batch_size, )</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_embeddings_keys</span><span class="p">:</span> 
            <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_dims</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="c1"># 0=masked, 1=not masked</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># in case of padding passage</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># keep zero-padding/mask</span>
                    <span class="k">continue</span>
                <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                <span class="n">attention_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">image_inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_inputs</span>               </div>
                                   
<div class="viewcode-block" id="MMTrainer.add_image_features"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MMTrainer.add_image_features">[docs]</a>    <span class="k">def</span> <span class="nf">add_image_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passages</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add image features to passages from self.image_kb&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">passages</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">passages</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">({</span><span class="s2">&quot;face_box&quot;</span><span class="p">,</span> <span class="s2">&quot;face_embedding&quot;</span><span class="p">}</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_embeddings_keys</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;passage&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">passage</span> <span class="ow">in</span> <span class="n">passages</span><span class="p">:</span>
            <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">passage</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
            <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">passage</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">])</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_kb</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">subset</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>
        <span class="c1"># dict of list to list of dict</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">values</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">output</span></div>
        
<div class="viewcode-block" id="MMTrainer.collate_fn"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MMTrainer.collate_fn">[docs]</a>    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="c1"># find relevant and irrelevant passages, pad if necessary</span>
        <span class="n">n_irrelevant_passages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span>
        <span class="n">questions</span><span class="p">,</span> <span class="n">relevant_passages</span><span class="p">,</span> <span class="n">irrelevant_passages</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">relevant_passage</span><span class="p">,</span> <span class="n">irrelevant_passage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_training_passages</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="c1"># Dataset to list (to get the same format as items)</span>
            <span class="n">relevant_passage</span><span class="p">,</span> <span class="n">irrelevant_passage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_image_features</span><span class="p">(</span><span class="n">relevant_passage</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_image_features</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_passage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">relevant_passage</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;passage&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}]</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fct</span><span class="o">.</span><span class="n">ignore_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_irrelevant_passages</span><span class="p">:</span>
                <span class="n">irrelevant_passage</span><span class="o">.</span><span class="n">extend</span><span class="p">([{</span><span class="s1">&#39;passage&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}]</span><span class="o">*</span><span class="p">(</span><span class="n">n_irrelevant_passages</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)))</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">])</span>
            <span class="n">relevant_passages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relevant_passage</span><span class="p">)</span>
            <span class="n">irrelevant_passages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">irrelevant_passage</span><span class="p">)</span>

        <span class="c1"># tokenize questions</span>
        <span class="n">question_inputs_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="c1"># concatenate passages and tokenize</span>
        <span class="n">all_passages</span> <span class="o">=</span> <span class="n">relevant_passages</span> <span class="o">+</span> <span class="n">irrelevant_passages</span>
        <span class="n">context_inputs_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_passages</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>

        <span class="c1"># get image features, for both questions and passages</span>
        <span class="n">question_inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">text_inputs</span><span class="o">=</span><span class="n">question_inputs_text</span><span class="p">,</span> 
            <span class="n">face_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_face_inputs</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> 
            <span class="n">image_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_inputs</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">context_inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">text_inputs</span><span class="o">=</span><span class="n">context_inputs_text</span><span class="p">,</span> 
            <span class="n">face_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_face_inputs</span><span class="p">(</span><span class="n">all_passages</span><span class="p">),</span> 
            <span class="n">image_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_inputs</span><span class="p">(</span><span class="n">all_passages</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># wrap it up</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">question_inputs</span><span class="o">=</span><span class="n">question_inputs</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span></div></div>


<div class="viewcode-block" id="ICTTrainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.ICTTrainer">[docs]</a><span class="k">class</span> <span class="nc">ICTTrainer</span><span class="p">(</span><span class="n">MMTrainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends the Inverse Cloze Task (ICT, [2]_) to multimodal documents.</span>
<span class="sd">    Given a wikipedia section, one sentence is considered as a pseudo-question/query and the nearby sentences as a pseudo-target/relevant passage.</span>
<span class="sd">    In this multimodal setting, we also consider the image of the section in the query and the infobox/main image of the article in the target.</span>

<span class="sd">    Inherits from MMTrainer/DPRBiEncoderTrainer and overrides:</span>
<span class="sd">        - ``get_training_passages``, which implements what’s described above</span>
<span class="sd">        - ``collate_fn`` to load and concatenate the image features</span>

<span class="sd">    The image_kb, kb and search_key attributes are not used.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args, **kwargs: </span>
<span class="sd">        additional arguments are passed to MMTrainer</span>
<span class="sd">    sentences_per_target: int, optional</span>
<span class="sd">        Number of sentences in the target passages</span>
<span class="sd">    prepend_title: bool, optional</span>
<span class="sd">        Whether to preprend the title of the article to the target passage</span>
<span class="sd">    text_mask_rate: float, optional</span>
<span class="sd">        Rate at which the pseudo-question is masked in the target passage</span>
<span class="sd">    image_mask_rate: float, optional</span>
<span class="sd">        Rate at which the infobox image is used as target (keep input image otherwise)</span>
<span class="sd">        </span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [2] Kenton Lee, Ming-Wei Chang, and Kristina Toutanova. 2019. Latent Retrieval for Weakly Supervised Open Domain Question Answering. </span>
<span class="sd">       In Proceedings of the 57th Annual Meeting of the Association for Computational Linguistics, </span>
<span class="sd">       pages 6086–6096, Florence, Italy. Association for Computational Linguistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sentences_per_target</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">prepend_title</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">text_mask_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">image_mask_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_kb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentences_per_target</span> <span class="o">=</span> <span class="n">sentences_per_target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepend_title</span> <span class="o">=</span> <span class="n">prepend_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_mask_rate</span> <span class="o">=</span> <span class="n">text_mask_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_mask_rate</span> <span class="o">=</span> <span class="n">image_mask_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span>

<div class="viewcode-block" id="ICTTrainer.get_training_passages"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.ICTTrainer.get_training_passages">[docs]</a>    <span class="k">def</span> <span class="nf">get_training_passages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Beware this does not return the same data as the parent classes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        query: dict</span>
<span class="sd">        target: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">]</span>

        <span class="c1"># pick a random sentence: easy</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">sentences</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
        <span class="c1"># pick n random sentences around it: more tricky</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentences_per_target</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">max_shift</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">):</span>
            <span class="n">min_shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_shift</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">min_shift</span><span class="p">,</span> <span class="n">max_shift</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># standard ICT: remove sentence from its context</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_mask_rate</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">shift</span><span class="p">:</span> <span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">sentences</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="n">shift</span><span class="p">]]</span>
        <span class="c1"># robustness trick: keep the sentence in the context so that the model learns lexical overlap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">shift</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="n">shift</span><span class="p">]]</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepend_title</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span><span class="p">)</span>
            <span class="n">target</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>  
        
        <span class="c1"># standard MICT: use the contextual image as target</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mask_rate</span><span class="p">:</span>
            <span class="n">context_image_key</span> <span class="o">=</span> <span class="s2">&quot;context_&quot;</span>
        <span class="c1"># robustness trick: use the same image in query/target so that the model keeps image information</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context_image_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># rename context image features</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">({</span><span class="s2">&quot;face_box&quot;</span><span class="p">,</span> <span class="s2">&quot;face_embedding&quot;</span><span class="p">}</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_embeddings_keys</span><span class="p">):</span>
            <span class="n">target</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">context_image_key</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">target</span></div>

    <span class="k">def</span> <span class="nf">_get_eval_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It’s important to shuffle even the evaluation set because the examples </span>
<span class="sd">        get really hard (even false negatives) if they come from the same Wikipedia article.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_legacy_prediction_loop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="c1"># Build the sampler.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">group_by_length</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">world_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">RandomSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>

<div class="viewcode-block" id="ICTTrainer.collate_fn"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.ICTTrainer.collate_fn">[docs]</a>    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="n">questions</span><span class="p">,</span> <span class="n">relevant_passages</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">relevant_passage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_training_passages</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">relevant_passages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relevant_passage</span><span class="p">)</span>

        <span class="n">question_inputs_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">([</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="n">context_inputs_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">relevant_passages</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="c1"># get image features, for both questions and passages</span>
        <span class="n">question_inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">text_inputs</span><span class="o">=</span><span class="n">question_inputs_text</span><span class="p">,</span> 
            <span class="n">face_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_face_inputs</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> 
            <span class="n">image_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_inputs</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">context_inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">text_inputs</span><span class="o">=</span><span class="n">context_inputs_text</span><span class="p">,</span> 
            <span class="n">face_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_face_inputs</span><span class="p">(</span><span class="n">relevant_passages</span><span class="p">),</span> 
            <span class="n">image_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_inputs</span><span class="p">(</span><span class="n">relevant_passages</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># make n_irrelevant_passages by shifting the images of relevant passages</span>
        <span class="n">n_irrelevant_passages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span>
        <span class="k">if</span> <span class="n">n_irrelevant_passages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># duplicate relevant text</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context_inputs</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">context_inputs</span><span class="p">[</span><span class="s2">&quot;text_inputs&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># shift relevant images</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;image_inputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">shifted_input</span><span class="p">,</span> <span class="n">shifted_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_irrelevant_passages</span><span class="p">):</span>
                    <span class="c1"># shift along axis 0 (batch axis)</span>
                    <span class="n">shifted_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span> <span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">shifted_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">],</span> <span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="c1"># cat along axis 0 (batch axis)</span>
                <span class="n">v</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">shifted_input</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">v</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">shifted_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># shift relevant faces</span>
            <span class="n">shifted_faces</span><span class="p">,</span> <span class="n">shifted_boxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;face&quot;</span><span class="p">]],</span> <span class="p">[</span><span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">]]</span>
            <span class="n">shifted_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_irrelevant_passages</span><span class="p">):</span>
                <span class="c1"># shift along axis 0 (batch axis)</span>
                <span class="n">shifted_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;face&quot;</span><span class="p">],</span> <span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">shifted_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">],</span> <span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">shifted_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span> <span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="c1"># cat along axis 0 (batch axis)</span>
            <span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;face&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">shifted_faces</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">shifted_boxes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">context_inputs</span><span class="p">[</span><span class="s1">&#39;face_inputs&#39;</span><span class="p">][</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">shifted_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># wrap it up</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">question_inputs</span><span class="o">=</span><span class="n">question_inputs</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span></div></div>


<div class="viewcode-block" id="MultiPassageBERTTrainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MultiPassageBERTTrainer">[docs]</a><span class="k">class</span> <span class="nc">MultiPassageBERTTrainer</span><span class="p">(</span><span class="n">QuestionAnsweringTrainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specific for RC, more precisely MultiPassageBERT</span>
<span class="sd">    (will I manage to code an extra-level of abstraction, e.g. ReadingComprehensionTrainer?)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args, **kwargs: </span>
<span class="sd">        additional arguments are passed to QuestionAnsweringTrainer</span>
<span class="sd">    max_n_answers: int, optional</span>
<span class="sd">        The answer might be found several time in the same passage, this is a threshold to enable batching</span>
<span class="sd">        Defaults to 10.</span>
<span class="sd">    ignore_keys: List[str], optional</span>
<span class="sd">        List of keys to remove from the batch before feeding it to the model</span>
<span class="sd">        (data not used by the model but necessary for evaluation)</span>
<span class="sd">        Defaults to [&#39;answer_strings&#39;]</span>
<span class="sd">    train_original_answer_only: bool, optional</span>
<span class="sd">        Whether the model should be trained to predict only the original answer (default)</span>
<span class="sd">        or all alternative answers (with the only limit of max_n_answers)</span>
<span class="sd">        This has no effect on the evaluation (where all alternative answers are always considered)</span>
<span class="sd">    oracle: bool, optional</span>
<span class="sd">        Whether to use only relevant passages at inference (stored in {search_key}_provenance_indices)</span>
<span class="sd">        Will enforce n_relevant_passages=M</span>
<span class="sd">        Defaults to False (use IR passages at inference, stored in {search_key}_indices)</span>
<span class="sd">    run_path: str, optional</span>
<span class="sd">        Path to the ranx run stored in the TREC format that holds the IR results.</span>
<span class="sd">        To be used instead of search_key at inference.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_n_answers</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;answer_strings&#39;</span><span class="p">],</span> 
                 <span class="n">train_original_answer_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">oracle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_n_answers</span> <span class="o">=</span> <span class="n">max_n_answers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_keys</span> <span class="o">=</span> <span class="n">ignore_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_original_answer_only</span> <span class="o">=</span> <span class="n">train_original_answer_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span> <span class="o">=</span> <span class="n">oracle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction_file_name</span> <span class="o">=</span> <span class="s2">&quot;oracle_predictions.json&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_file_name</span> <span class="o">=</span> <span class="s2">&quot;oracle_metrics.json&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Oracle mode. Setting n_relevant_passages=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_relevant_passages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>
                
        <span class="k">if</span> <span class="n">run_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">ranx</span><span class="o">.</span><span class="n">Run</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="s1">&#39;trec&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># FIXME isn&#39;t there a more robust way of defining data_collator as the method collate_fn ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span>

<div class="viewcode-block" id="MultiPassageBERTTrainer.get_eval_passages"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MultiPassageBERTTrainer.get_eval_passages">[docs]</a>    <span class="k">def</span> <span class="nf">get_eval_passages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Keep the top-M passages retrieved by the IR&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">search_key</span><span class="o">+</span><span class="s2">&quot;_indices&quot;</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">search_key</span><span class="o">+</span><span class="s2">&quot;_scores&quot;</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ir_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
            <span class="c1"># document ids in ranx are str so we map them back to indices (int)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ir_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ir_results</span><span class="o">.</span><span class="n">values</span><span class="p">())[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="MultiPassageBERTTrainer.get_answer_position"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MultiPassageBERTTrainer.get_answer_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_answer_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">answers</span><span class="p">,</span> <span class="n">answer_mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adapted from DPR&quot;&quot;&quot;</span>
        <span class="n">start_positions</span><span class="p">,</span> <span class="n">end_positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">answer_mask</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">answer_mask</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span> <span class="n">answers</span><span class="p">)):</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">answer_starts</span><span class="p">,</span> <span class="n">answer_ends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">:</span>
                <span class="n">answer_len</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">enough</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">answer_len</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">input_ids</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="n">answer_len</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">answer_len</span><span class="o">-</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">answer_starts</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">answer_ends</span><span class="p">:</span>
                            <span class="n">answer_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                            <span class="n">answer_ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_starts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n_answers</span><span class="p">:</span>
                                <span class="n">enough</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="n">enough</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">answer_starts</span><span class="p">,</span> <span class="n">answer_ends</span><span class="p">)):</span>
                <span class="n">start_positions</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
                <span class="n">end_positions</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span>
                <span class="c1"># un-mask answer</span>
                <span class="n">answer_mask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">start_positions</span> <span class="o">=</span> <span class="n">start_positions</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n_answers</span><span class="p">)</span>
        <span class="n">end_positions</span> <span class="o">=</span> <span class="n">end_positions</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n_answers</span><span class="p">)</span>
        <span class="n">answer_mask</span> <span class="o">=</span> <span class="n">answer_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n_answers</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">start_positions</span><span class="o">=</span><span class="n">start_positions</span><span class="p">,</span> <span class="n">end_positions</span><span class="o">=</span><span class="n">end_positions</span><span class="p">,</span> <span class="n">answer_mask</span><span class="o">=</span><span class="n">answer_mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">batch</span></div>

<div class="viewcode-block" id="MultiPassageBERTTrainer.collate_fn"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MultiPassageBERTTrainer.collate_fn">[docs]</a>    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collate batch so that each question is associate with n_relevant_passages and M-n irrelevant ones.</span>
<span class="sd">        Also tokenizes input strings</span>

<span class="sd">        Returns (a dict of)</span>
<span class="sd">        -------------------</span>
<span class="sd">        input_ids: Tensor[int]</span>
<span class="sd">            shape (N * M, L)</span>
<span class="sd">        start_positions, end_positions: Tensor[int]</span>
<span class="sd">            shape (N, M, max_n_answers)</span>
<span class="sd">        answer_mask: Tensor[int]</span>
<span class="sd">            shape (N, M, max_n_answers)</span>
<span class="sd">        passage_scores: Tensor[float], optional</span>
<span class="sd">            shape (N * M)</span>
<span class="sd">            only in evaluation mode</span>
<span class="sd">        **kwargs: more tensors depending on the tokenizer, e.g. attention_mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">questions</span><span class="p">,</span> <span class="n">passages</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">answers</span><span class="p">,</span> <span class="n">answer_strings</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">passage_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">answer_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n_answers</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="c1"># N. B. seed is set in Trainer</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

            <span class="c1"># oracle -&gt; use only relevant passages</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">do_eval</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">do_predict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span><span class="p">:</span>
                <span class="n">passage</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eval_passages</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">passage</span> <span class="o">=</span> <span class="n">passage</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span>
                <span class="n">passage_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">:</span>
                    <span class="n">passage_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relevant_passage</span><span class="p">,</span> <span class="n">irrelevant_passage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_training_passages</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">passage</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">relevant_passage</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;passage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">irrelevant_passage</span><span class="p">]</span>

            <span class="n">passages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">passage</span><span class="p">)</span>
            <span class="c1"># all passages have at least 1 non-masked answer (set to 0 for irrelevant passages)</span>
            <span class="n">answer_mask</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">:</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">passage</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># except for padding passages</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">passage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">:</span>
                <span class="n">passages</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">passage</span><span class="p">)))</span>

            <span class="n">original_answer</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;original_answer&#39;</span><span class="p">]</span>
            <span class="c1"># avoid processing the same answer twice</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span>
            <span class="n">answer_strings</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">answer</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="c1"># beware this create a discrepancy between answer_strings and answers (tokens)</span>
            <span class="c1"># evaluation should always be done using answer_strings</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_original_answer_only</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="n">original_answer</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">do_lower_case</span><span class="p">:</span>
                    <span class="n">original_answer</span> <span class="o">=</span> <span class="n">original_answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">answer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">}</span> <span class="o">-</span> <span class="p">{</span><span class="n">original_answer</span><span class="p">})</span>
                <span class="c1"># but ensure the original answer is still the first to be processed</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="n">original_answer</span><span class="p">]</span> <span class="o">+</span> <span class="n">answer</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span>
                                    <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_token_type_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_attention_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">]</span>
            <span class="n">answers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">answer</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="n">passages</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenization_kwargs</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_answer_position</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">answers</span><span class="p">,</span> <span class="n">answer_mask</span><span class="p">)</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;answer_strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_strings</span>
        <span class="k">if</span> <span class="n">passage_scores</span><span class="p">:</span>
            <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;passage_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">passage_scores</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">batch</span></div>

    <span class="k">def</span> <span class="nf">_prepare_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;remove all keys not used by the model but necessary for evaluation before returning Trainer._prepare_inputs&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t find </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> in inputs&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

<div class="viewcode-block" id="MultiPassageBERTTrainer.log_probs_to_answers"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MultiPassageBERTTrainer.log_probs_to_answers">[docs]</a>    <span class="k">def</span> <span class="nf">log_probs_to_answers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;</span>
<span class="sd">        1. get span start and end positions from log-probabilities</span>
<span class="sd">        2. extract actual tokens (answer) from input_ids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">start_log_probs</span><span class="p">,</span> <span class="n">end_log_probs</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="n">passage_indices</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">,</span> <span class="n">end_indices</span> <span class="o">=</span> <span class="n">get_best_spans</span><span class="p">(</span><span class="n">start_probs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">start_log_probs</span><span class="p">),</span>
                                                                     <span class="n">end_probs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">end_log_probs</span><span class="p">),</span>
                                                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">passage_index</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">passage_indices</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">,</span> <span class="n">end_indices</span><span class="p">)):</span>
            <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">passage_index</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">end</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">answers</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiPassageBERTTrainer.evaluation_loop"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.MultiPassageBERTTrainer.evaluation_loop">[docs]</a>    <span class="k">def</span> <span class="nf">evaluation_loop</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataloader</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prediction_loss_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metric_key_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;eval&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EvalLoopOutput</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as Trainer.evaluation_loop but does not truncate output to the size of the dataset because</span>
<span class="sd">        there is M passages per question so the output is M times the size of the dataset</span>

<span class="sd">        Also gather input_ids instead of labels in order to recover the tokens from the model&#39;s span start and end probabilities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prediction_loss_only</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">prediction_loss_only</span> <span class="k">if</span> <span class="n">prediction_loss_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prediction_loss_only</span>
        <span class="p">)</span>

        <span class="c1"># if eval is called w/o train init deepspeed here</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deepspeed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepspeed</span><span class="p">:</span>

            <span class="c1"># XXX: eval doesn&#39;t have `resume_from_checkpoint` arg but we should be able to do eval</span>
            <span class="c1"># from the checkpoint eventually</span>
            <span class="n">deepspeed_engine</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">deepspeed_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">deepspeed_engine</span><span class="o">.</span><span class="n">module</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapped</span> <span class="o">=</span> <span class="n">deepspeed_engine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepspeed</span> <span class="o">=</span> <span class="n">deepspeed_engine</span>
            <span class="c1"># XXX: we don&#39;t need optim/sched for inference, but this needs to be sorted out, since</span>
            <span class="c1"># for example the Z3-optimizer is a must for zero3 to work even for inference - what we</span>
            <span class="c1"># don&#39;t need is the deepspeed basic optimizer which is self.optimizer.optimizer</span>
            <span class="n">deepspeed_engine</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">deepspeed_engine</span><span class="o">.</span><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># if full fp16 is wanted on eval and this ``evaluation`` or ``predict`` isn&#39;t called while</span>
        <span class="c1"># ``train`` is running, halve it first and then put on device</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_train</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">fp16_full_eval</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">half</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;***** Running </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2"> *****&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sized</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Num examples = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_examples</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Num examples: Unknown&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Batch size = </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback_handler</span><span class="o">.</span><span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">dataloader</span>
        <span class="c1"># Do this before wrapping.</span>
        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span>

        <span class="k">if</span> <span class="n">is_torch_tpu_available</span><span class="p">():</span>
            <span class="n">dataloader</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ParallelLoader</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">])</span><span class="o">.</span><span class="n">per_device_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">past_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_past</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize containers</span>
        <span class="c1"># losses/preds/input_ids on GPU/TPU (accumulated for eval_accumulation_steps)</span>
        <span class="n">losses_host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">preds_host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">input_ids_host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">passage_scores_host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># losses/preds/input_ids on CPU (final containers)</span>
        <span class="n">all_losses</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_preds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_input_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_passage_scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_answers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Will be useful when we have an iterable dataset so don&#39;t know its length.</span>
        <span class="n">observed_num_examples</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Main evaluation loop</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">answer_strings</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;answer_strings&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">answer_strings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_answers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">answer_strings</span><span class="p">)</span>
            <span class="n">passage_score</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passage_scores&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">passage_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">passage_scores_host</span> <span class="o">=</span> <span class="n">passage_score</span> <span class="k">if</span> <span class="n">passage_scores_host</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">passage_scores_host</span><span class="p">,</span> <span class="n">passage_score</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Update the observed num examples</span>
            <span class="n">observed_batch_size</span> <span class="o">=</span> <span class="n">find_batch_size</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">observed_batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">observed_num_examples</span> <span class="o">+=</span> <span class="n">observed_batch_size</span>

            <span class="c1"># Prediction step</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">prediction_loss_only</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">)</span>

            <span class="c1"># Update containers on host</span>
            <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_gather</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>
                <span class="n">losses_host</span> <span class="o">=</span> <span class="n">losses</span> <span class="k">if</span> <span class="n">losses_host</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">losses_host</span><span class="p">,</span> <span class="n">losses</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_across_processes</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_gather</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
                <span class="n">preds_host</span> <span class="o">=</span> <span class="n">logits</span> <span class="k">if</span> <span class="n">preds_host</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">preds_host</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_across_processes</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_gather</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
            <span class="n">input_ids_host</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="k">if</span> <span class="n">input_ids_host</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">input_ids_host</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_handler</span><span class="o">.</span><span class="n">on_prediction_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">)</span>

            <span class="c1"># Gather all tensors and put them back on the CPU if we have done enough accumulation steps.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_accumulation_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">losses_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">losses</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">losses_host</span><span class="p">)</span>
                    <span class="n">all_losses</span> <span class="o">=</span> <span class="n">losses</span> <span class="k">if</span> <span class="n">all_losses</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">all_losses</span><span class="p">,</span> <span class="n">losses</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">preds_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logits</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">preds_host</span><span class="p">)</span>
                    <span class="n">all_preds</span> <span class="o">=</span> <span class="n">logits</span> <span class="k">if</span> <span class="n">all_preds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">input_ids_host</span><span class="p">)</span>
                <span class="n">all_input_ids</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">input_ids</span> <span class="k">if</span> <span class="n">all_input_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">all_input_ids</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">passage_scores_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">passage_scores</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">passage_scores_host</span><span class="p">)</span>
                    <span class="n">all_passage_scores</span> <span class="o">=</span> <span class="n">passage_scores</span> <span class="k">if</span> <span class="n">all_passage_scores</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">all_passage_scores</span><span class="p">,</span> <span class="n">passage_scores</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Set back to None to begin a new accumulation</span>
                <span class="n">losses_host</span><span class="p">,</span> <span class="n">preds_host</span><span class="p">,</span> <span class="n">input_ids_host</span><span class="p">,</span> <span class="n">passage_scores_host</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">past_index</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_past&quot;</span><span class="p">):</span>
            <span class="c1"># Clean the state at the end of the evaluation loop</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_past&quot;</span><span class="p">)</span>

        <span class="c1"># Number of samples</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">IterableDataset</span><span class="p">):</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">IterableDatasetShard</span><span class="p">):</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">num_examples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="n">observed_num_examples</span>

        <span class="c1"># Gather all remaining tensors and put them back on the CPU</span>
        <span class="k">if</span> <span class="n">losses_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">losses_host</span><span class="p">)</span>
            <span class="n">all_losses</span> <span class="o">=</span> <span class="n">losses</span> <span class="k">if</span> <span class="n">all_losses</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">all_losses</span><span class="p">,</span> <span class="n">losses</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">preds_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">preds_host</span><span class="p">)</span>
            <span class="n">all_preds</span> <span class="o">=</span> <span class="n">logits</span> <span class="k">if</span> <span class="n">all_preds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_ids_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">input_ids_host</span><span class="p">)</span>
            <span class="n">all_input_ids</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="k">if</span> <span class="n">all_input_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">all_input_ids</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">passage_scores_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">passage_scores</span> <span class="o">=</span> <span class="n">nested_numpify</span><span class="p">(</span><span class="n">passage_scores_host</span><span class="p">)</span>
            <span class="n">all_passage_scores</span> <span class="o">=</span> <span class="n">passage_scores</span> <span class="k">if</span> <span class="n">all_passage_scores</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nested_concat</span><span class="p">(</span><span class="n">all_passage_scores</span><span class="p">,</span> <span class="n">passage_scores</span><span class="p">,</span> <span class="n">padding_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># reshape like (N, M, L) to ease further processing</span>
        <span class="k">if</span> <span class="n">all_preds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_preds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">all_preds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_input_ids</span> <span class="o">=</span> <span class="n">all_input_ids</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_passage_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_passage_scores</span> <span class="o">=</span> <span class="n">all_passage_scores</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_answers</span><span class="p">:</span>
            <span class="n">all_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_answers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_answers</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_answers</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_samples</span>

        <span class="c1"># Metrics!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">all_preds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">all_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">all_answers</span><span class="p">:</span>
            <span class="c1"># 1. raw predictions from scores spans</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_probs_to_answers</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">all_input_ids</span><span class="p">)</span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">references</span> <span class="o">=</span> <span class="n">format_predictions_for_squad</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">all_answers</span><span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">references</span><span class="p">)</span>
            <span class="c1"># 2. weighted predictions</span>
            <span class="k">if</span> <span class="n">all_passage_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weighted_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_probs_to_answers</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">all_input_ids</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">all_passage_scores</span><span class="p">)</span>
                <span class="n">weighted_predictions</span><span class="p">,</span> <span class="n">references</span> <span class="o">=</span> <span class="n">format_predictions_for_squad</span><span class="p">(</span><span class="n">weighted_predictions</span><span class="p">,</span> <span class="n">all_answers</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">weighted_predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">references</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;weighted_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">all_preds</span>

        <span class="c1"># To be JSON-serializable, we need to remove numpy types or zero-d tensors</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">denumpify_detensorize</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_losses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_key_prefix</span><span class="si">}</span><span class="s2">_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_losses</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># Prefix all keys with metric_key_prefix + &#39;_&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_key_prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">):</span>
                <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_key_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">EvalLoopOutput</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">label_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_checkpoint"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.get_checkpoint">[docs]</a><span class="k">def</span> <span class="nf">get_checkpoint</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resume_from_checkpoint: str, optional</span>
<span class="sd">        Path (possibly regex) to the directory(ies) checkpointed during training (that hold ``pytorch_model.bin`` etc.)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    resume_from_checkpoints: list[Path]</span>
<span class="sd">        List of path to the checkpoints, sorted by ascending training step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ignoring additional arguments:</span><span class="se">\n</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="p">)</span>
    <span class="c1"># weird trick to glob using pathlib</span>
    <span class="n">resume_from_checkpoints</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">cpt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># sort by checkpoint number</span>
    <span class="n">resume_from_checkpoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resume_from_checkpoints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">resume_from_checkpoints</span></div>


<div class="viewcode-block" id="subsample_dataset"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.subsample_dataset">[docs]</a><span class="k">def</span> <span class="nf">subsample_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shuffles and shards the input dataset in num_shards.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset: Dataset</span>
<span class="sd">    num_shards: int</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dataset: Dataset</span>
<span class="sd">        First shard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">before_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">after_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharded the dataset from </span><span class="si">{</span><span class="n">before_len</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">after_len</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="filter_rels"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.filter_rels">[docs]</a><span class="k">def</span> <span class="nf">filter_rels</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">search_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out questions of the dataset without any relevant passages.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset: Dataset</span>
<span class="sd">    search_key: str</span>
<span class="sd">        see QuestionAnsweringTrainer</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dataset: Dataset</span>
<span class="sd">        With at least one relevant passage for all questions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">before_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="c1"># FIXME: should also work when a ranx Run is used instead of search_key</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">search_key</span><span class="si">}</span><span class="s2">_provenance_indices&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">after_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered the dataset with empty &#39;</span><span class="si">{</span><span class="n">search_key</span><span class="si">}</span><span class="s2">_provenance_indices&#39; from </span><span class="si">{</span><span class="n">before_len</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">after_len</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span></div>
    
    
<div class="viewcode-block" id="instantiate_trainer"><a class="viewcode-back" href="../../../meerqat.train.trainer.html#meerqat.train.trainer.instantiate_trainer">[docs]</a><span class="k">def</span> <span class="nf">instantiate_trainer</span><span class="p">(</span><span class="n">trainee</span><span class="p">,</span> <span class="n">trainer_class</span><span class="o">=</span><span class="s2">&quot;MultiPassageBERTTrainer&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">train_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;squad&#39;</span><span class="p">,</span> 
                        <span class="n">training_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">callbacks_args</span><span class="o">=</span><span class="p">[],</span> 
                        <span class="n">train_shards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_shards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">filter_train_rels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filter_eval_rels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">search_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiates Trainer and TrainingArguments, loads and processes data</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trainee: nn.Module</span>
<span class="sd">        see meerqat.train.trainee</span>
<span class="sd">    trainer_class: str, optional</span>
<span class="sd">        Name of one of the classes defined above.</span>
<span class="sd">    debug: bool, optional</span>
<span class="sd">        see torch.autograd.detect_anomaly</span>
<span class="sd">    train_dataset, eval_dataset: str, optional</span>
<span class="sd">        Path to the train or eval datasets</span>
<span class="sd">    metric: str, optional</span>
<span class="sd">        Name of a metric defined in meerqat.train.metrics or in datasets</span>
<span class="sd">    training_kwargs: dict, optional</span>
<span class="sd">        Passed to TrainingArguments</span>
<span class="sd">    callbacks_args: list[dict], optional</span>
<span class="sd">        Added to trainer with Trainer.add_callback</span>
<span class="sd">    train_shards, eval_shards: int, optional</span>
<span class="sd">        see subsample_dataset</span>
<span class="sd">    filter_train_rels, filter_eval_rels: bool, optional</span>
<span class="sd">        see filter_rels</span>
<span class="sd">    search_key: str, optional</span>
<span class="sd">        see QuestionAnsweringTrainer</span>
<span class="sd">    **kwargs:</span>
<span class="sd">        Passed to Trainer</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trainer: Trainer</span>
<span class="sd">    training_args: TrainingArguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># debug (see torch.autograd.detect_anomaly)</span>
    <span class="n">set_detect_anomaly</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>

    <span class="c1"># data</span>
    <span class="k">if</span> <span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">train_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">subsample_dataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">train_shards</span><span class="p">)</span>
        <span class="c1"># filter questions without any relevant passages to train</span>
        <span class="k">if</span> <span class="n">filter_train_rels</span><span class="p">:</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">filter_rels</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">search_key</span><span class="o">=</span><span class="n">search_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eval_shards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">subsample_dataset</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">eval_shards</span><span class="p">)</span>
        <span class="c1"># filter questions without any relevant passages to train</span>
        <span class="k">if</span> <span class="n">filter_eval_rels</span><span class="p">:</span>
            <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">filter_rels</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">search_key</span><span class="o">=</span><span class="n">search_key</span><span class="p">)</span>

    <span class="c1"># training</span>
    <span class="c1"># revert the post-init that overrides do_eval</span>
    <span class="n">do_eval</span> <span class="o">=</span> <span class="n">training_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;do_eval&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span><span class="o">**</span><span class="n">training_kwargs</span><span class="p">)</span>
    <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span> <span class="o">=</span> <span class="n">do_eval</span>

    <span class="c1"># metrics come in priority from meerqat.train.metrics</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">compute_metrics</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metric_functions</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># or from HF&#39;s datasets</span>
        <span class="k">if</span> <span class="n">compute_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">load_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">compute_metrics</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compute_metrics</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">TrainerClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">trainer_class</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">TrainerClass</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">trainee</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
                           <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span>
                           <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span> <span class="n">search_key</span><span class="o">=</span><span class="n">search_key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># training callbacks</span>
    <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks_args</span><span class="p">:</span>
        <span class="n">CallbackClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">trainer_callback</span><span class="p">,</span> <span class="n">callback</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;Class&quot;</span><span class="p">))</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">CallbackClass</span><span class="p">(</span><span class="o">**</span><span class="n">callback</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">training_args</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;entering main </span><span class="si">{</span><span class="n">max_memory_usage</span><span class="p">(</span><span class="n">human</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># load and parse arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;config&gt;&#39;</span><span class="p">])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_pretrained_in_kwargs</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after loading pre-trained models </span><span class="si">{</span><span class="n">max_memory_usage</span><span class="p">(</span><span class="n">human</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">trainer</span><span class="p">,</span> <span class="n">training_args</span> <span class="o">=</span> <span class="n">instantiate_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">device</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after instantiating trainer </span><span class="si">{</span><span class="n">max_memory_usage</span><span class="p">(</span><span class="n">human</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">**</span><span class="n">checkpoint</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_eval</span><span class="p">:</span>
        <span class="n">resume_from_checkpoints</span> <span class="o">=</span> <span class="n">get_checkpoint</span><span class="p">(</span><span class="o">**</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">resume_from_checkpoint</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">resume_from_checkpoints</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Evaluation&quot;</span><span class="p">):</span>
            <span class="c1"># zero-shot test</span>
            <span class="k">if</span> <span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># load state dict</span>
            <span class="n">state_dict_path</span> <span class="o">=</span> <span class="n">resume_from_checkpoint</span> <span class="o">/</span> <span class="n">WEIGHTS_NAME</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">state_dict_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">state_dict_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">_load_state_dict_in_model</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

            <span class="c1"># optionally load trainer state for better logging</span>
            <span class="n">trainer_state</span> <span class="o">=</span> <span class="n">resume_from_checkpoint</span><span class="o">/</span><span class="s2">&quot;trainer_state.json&quot;</span>
            <span class="k">if</span> <span class="n">trainer_state</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">TrainerState</span><span class="o">.</span><span class="n">load_from_json</span><span class="p">(</span><span class="n">trainer_state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t load trainer state, TB logging might use an inappropriate step&quot;</span><span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">write_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">training_args</span><span class="o">.</span><span class="n">do_predict</span><span class="p">:</span>
        <span class="n">resume_from_checkpoints</span> <span class="o">=</span> <span class="n">get_checkpoint</span><span class="p">(</span><span class="o">**</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">resume_from_checkpoint</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">resume_from_checkpoints</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Prediction&quot;</span><span class="p">):</span>
            <span class="c1"># load state dict</span>
            <span class="n">state_dict_path</span> <span class="o">=</span> <span class="n">resume_from_checkpoint</span> <span class="o">/</span> <span class="n">WEIGHTS_NAME</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">state_dict_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">state_dict_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">_load_state_dict_in_model</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

            <span class="c1"># run model on evaluation dataset</span>
            <span class="n">prediction_output</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">write_metrics</span><span class="p">(</span><span class="n">prediction_output</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">write_predictions</span><span class="p">(</span><span class="n">prediction_output</span><span class="o">.</span><span class="n">predictions</span><span class="p">,</span> <span class="n">resume_from_checkpoint</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Did nothing except instantiate the trainer, &quot;</span>
                      <span class="s2">&quot;you probably want to set do_train, do_eval or do_predict to True&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;see </span><span class="si">{</span><span class="n">training_args</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, CNRS.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.1.1.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>