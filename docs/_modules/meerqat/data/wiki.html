
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>meerqat.data.wiki &#8212; meerqat v3.0.0-alpha documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">

  
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/meerqat/data/wiki';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fas fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">meerqat v3.0.0-alpha documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fas fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <h1>Source code for meerqat.data.wiki</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">======</span>
<span class="sd">Usages</span>
<span class="sd">======</span>
<span class="sd">Gathers data about entities mentioned in questions via Wikidata, Wikimedia Commons SPARQL services and Wikimedia REST API.</span>

<span class="sd">You should run all of these in this order to get the whole cake:</span>

<span class="sd">-----------------</span>
<span class="sd">``data entities``</span>
<span class="sd">-----------------</span>

<span class="sd">**input/output**: ``entities.json`` (output of ``kilt2vqa.py count_entities``)  </span>
<span class="sd">queries many different attributes for all entities in the questions </span>

<span class="sd">Also sets a &#39;reference image&#39; to the entity using Wikidata properties in the following order of preference:</span>
<span class="sd">    - P18 ‘image’ (it is roughly equivalent to the infobox image in Wikipedia articles)</span>
<span class="sd">    - P154 ‘logo image’</span>
<span class="sd">    - P41 ‘flag image’</span>
<span class="sd">    - P94 ‘coat of arms image’</span>
<span class="sd">    - P2425 ‘service ribbon image’</span>

<span class="sd">-----------------</span>
<span class="sd">``data feminine``</span>
<span class="sd">-----------------</span>
<span class="sd">**input**: ``entities.json``  </span>
<span class="sd">**output**: ``feminine_labels.json``  </span>
<span class="sd">gets feminine labels for classes and occupations of these entities</span>

<span class="sd">---------------------</span>
<span class="sd">``data superclasses``</span>
<span class="sd">---------------------</span>
<span class="sd">**input**: ``entities.json``  </span>
<span class="sd">**output**: ``&lt;n&gt;_superclasses.json``  </span>

<span class="sd">gets the superclasses of the entities classes up ``n`` level (defaults to &#39;all&#39;, i.e. up to the root)</span>

<span class="sd">---------------------</span>
<span class="sd">Depictions (optional)</span>
<span class="sd">---------------------</span>
<span class="sd">we found that heuristics/images based on depictions were not that discriminative</span>

<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">``commons sparql depicts``</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">**input/output**: ``entities.json``  </span>
<span class="sd">Find all images in Commons that *depict* the entities</span>

<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">``commons sparql depicted``</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">**input**: ``entities.json``  </span>
<span class="sd">**output**: ``depictions.json``  </span>
<span class="sd">Find all entities depicted in the previously gathered step</span>

<span class="sd">^^^^^^^^^^^^^^^^^</span>
<span class="sd">``data depicted``</span>
<span class="sd">^^^^^^^^^^^^^^^^^</span>
<span class="sd">**input**: ``entities.json``, ``depictions.json``   </span>
<span class="sd">**output**: ``entities.json``  </span>
<span class="sd">Gathers the same data as in ``wiki.py data entities &lt;subset&gt;`` for *all* entities depicted in any of the depictions  </span>
<span class="sd">Then apply a heuristic to tell whether an image depicts the entity prominently or not:</span>
<span class="sd">*the depiction is prominent if the entity is the only one of its class*, e.g.:</span>
<span class="sd">    - *pic of Barack Obama and Joe Biden* -&gt; not prominent  </span>
<span class="sd">    - *pic of Barack Obama and the Eiffel Tower* -&gt; prominent  </span>

<span class="sd">Note this heuristic is not used in ``commons heuristics``</span>


<span class="sd">----------</span>
<span class="sd">``filter``</span>
<span class="sd">----------</span>
<span class="sd">**input/output**: ``entities.json``  </span>
<span class="sd">Filters entities w.r.t. to their class/nature/&quot;instance of&quot; and date of death, see ``wiki.py`` docstring for option usage (TODO share concrete_entities/abstract_entities)</span>
<span class="sd">Also entities with a ‘sex or gender’ (P21) or ‘occupation’ (P106) are kept by default.</span>

<span class="sd">Note this deletes data so maybe save it if you&#39;re unsure about the filter.</span>

<span class="sd">----------------</span>
<span class="sd">``commons rest``</span>
<span class="sd">----------------</span>
<span class="sd">**input/output**: ``entities.json``  </span>

<span class="sd">Gathers images and subcategories recursively from the entity root commons-category</span>

<span class="sd">Except if you have a very small dataset you should probably set ``--max_images=0`` to query only categories and use ``wikidump.py`` to gather images from those.  </span>
<span class="sd">``--max_categories`` defaults to 100.</span>


<span class="sd">----------------------</span>
<span class="sd">``commons heuristics``</span>
<span class="sd">----------------------</span>
<span class="sd">**input/output**: ``entities.json``  </span>
<span class="sd">Run ``wikidump.py`` first to gather images.  </span>
<span class="sd">Compute heuristics for the image (control with ``&lt;heuristic&gt;``, default to all):</span>
<span class="sd">    - ``categories``: the entity label should be included in *all* of the image category</span>
<span class="sd">    - ``description``: the entity label should be included in the image description</span>
<span class="sd">    - ``title``: the entity label should be included in the image title/file name</span>
<span class="sd">    - ``depictions``: the image should be tagged as *depicting* the entity (gathered in ``commons sparql depicts``)</span>


<span class="sd">==============</span>
<span class="sd">For ``docopt``</span>
<span class="sd">==============</span>


<span class="sd">Usage:</span>
<span class="sd">wiki.py data entities &lt;subset&gt; [--skip=&lt;attribute&gt;]</span>
<span class="sd">wiki.py data feminine &lt;subset&gt;</span>
<span class="sd">wiki.py data depicted &lt;subset&gt;</span>
<span class="sd">wiki.py data superclasses &lt;subset&gt; [--n=&lt;n&gt;]</span>
<span class="sd">wiki.py commons sparql depicts &lt;subset&gt;</span>
<span class="sd">wiki.py commons sparql depicted &lt;subset&gt;</span>
<span class="sd">wiki.py commons rest &lt;subset&gt; [--max_images=&lt;max_images&gt; --max_categories=&lt;max_categories&gt;]</span>
<span class="sd">wiki.py commons heuristics &lt;subset&gt; [&lt;heuristic&gt;...]</span>
<span class="sd">wiki.py filter &lt;subset&gt; [--superclass=&lt;level&gt; --positive --negative --deceased=&lt;year&gt; &lt;classes_to_exclude&gt;...]</span>

<span class="sd">Options:</span>
<span class="sd">--n=&lt;n&gt;                          Maximum level of superclasses. Defaults to all superclasses</span>
<span class="sd">--max_images=&lt;n&gt;                 Maximum number of images to query per entity/root category.</span>
<span class="sd">                                     Set to 0 if you only want to query categories [default: 1000].</span>
<span class="sd">--max_categories=&lt;n&gt;             Maximum number of categories to query per entity/root category [default: 100].</span>
<span class="sd">&lt;heuristic&gt;...                   Heuristic to compute for the image, one of {&quot;categories&quot;, &quot;description&quot;, &quot;depictions&quot;, &quot;title&quot;}</span>
<span class="sd">                                    Defaults to all valid heuristics (listed above)</span>
<span class="sd">--superclass=&lt;level&gt;             Level of superclasses in the filter, int or &quot;all&quot; (defaults to None i.e. filter only classes)</span>
<span class="sd">--positive                       Keep only classes in &quot;concrete_entities&quot; + entities with gender (P21) or occupation (P106).</span>
<span class="sd">                                    Applied before negative_filter.</span>
<span class="sd">--negative                       Keep only classes that are not in &quot;abstract_entities&quot;. Applied after positive_filter</span>
<span class="sd">--deceased=&lt;year&gt;                Remove humans (Q5) that are alive or deceased after &lt;year&gt; (might avoid trouble with GDPR)</span>
<span class="sd">&lt;classes_to_exclude&gt;...          Additional classes to exclude in the negative_filter (e.g. &quot;Q5 Q82794&quot;)</span>
<span class="sd">                                    Note that you can use this option even without --negative i.e. specifying your own &quot;abstract_entities&quot;</span>

<span class="sd">=========</span>
<span class="sd">Functions</span>
<span class="sd">=========</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">SPARQLWrapper</span> <span class="kn">import</span> <span class="n">SPARQLWrapper</span><span class="p">,</span> <span class="n">JSON</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">from</span> <span class="nn">urllib3.exceptions</span> <span class="kn">import</span> <span class="n">MaxRetryError</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">docopt</span> <span class="kn">import</span> <span class="n">docopt</span>

<span class="kn">from</span> <span class="nn">.loading</span> <span class="kn">import</span> <span class="n">DATA_ROOT_PATH</span><span class="p">,</span> <span class="n">COMMONS_PATH</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">md5</span>

<span class="c1"># One client (user agent + IP) is allowed 60 seconds of processing time each 60 seconds</span>
<span class="c1"># https://www.mediawiki.org/wiki/Wikidata_Query_Service/User_Manual</span>
<span class="n">WIKIDATA_COMPUTE_LIMIT</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">QID_URI_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;http://www.wikidata.org/entity/&quot;</span>
<span class="n">HUMAN</span> <span class="o">=</span> <span class="n">QID_URI_PREFIX</span> <span class="o">+</span> <span class="s1">&#39;Q5&#39;</span>

<span class="n">SPECIAL_PATH_URI_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;http://commons.wikimedia.org/wiki/Special:FilePath/&quot;</span>
<span class="n">SPECIAL_FILE_PATH_URI_PREFIX</span> <span class="o">=</span> <span class="n">SPECIAL_PATH_URI_PREFIX</span> <span class="o">+</span> <span class="s2">&quot;File:&quot;</span>
<span class="n">UPLOAD_URI_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;http://upload.wikimedia.org/wikipedia/commons/&quot;</span>
<span class="n">VALID_DATE_TYPE</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/XMLSchema#dateTime&#39;</span>

<span class="c1"># restrict media to be images handleable by PIL.Image (or convertible with Wikimedia thumbnails)</span>
<span class="n">VALID_ENCODING</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;gif&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="s2">&quot;tif&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;djvu&quot;</span><span class="p">}</span>

<span class="c1"># used to make thumbnails in file_name_to_thumbnail</span>
<span class="n">EXTENSIONS_PRE_AND_SUFFIXES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;svg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">),</span>
    <span class="s2">&quot;tif&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;lossy-page1-&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">),</span>
    <span class="s2">&quot;tiff&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;lossy-page1-&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">),</span>
    <span class="s2">&quot;pdf&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;page1-&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">),</span>
    <span class="s2">&quot;djvu&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;page1-&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># rules of preferences over licenses, the higher the better (0 is reserved for missing values or other licenses)</span>
<span class="n">LICENSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CC0&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;PUBLIC DOMAIN MARK&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;PUBLIC DOMAIN&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;PDM&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;BY&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;BY-SA&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;BY-NC&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;BY-ND&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;BY-NC-SA&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;BY-NC-ND&quot;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="c1"># Template for wikidata to query many different attributes of a list of entities</span>
<span class="c1"># should be used like</span>
<span class="c1"># &gt;&gt;&gt; WIKIDATA_QUERY % &quot;wd:Q76 wd:Q78579194 wd:Q42 wd:Q243&quot;</span>
<span class="c1"># i.e. entity ids are space-separated and prefixed by &#39;wd:&#39;</span>
<span class="n">WIKIDATA_QUERY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT ?entity ?entityLabel ?instanceof ?instanceofLabel ?commons ?image ?flag ?coat_of_arms ?logo ?service_ribbon ?occupation ?occupationLabel ?gender ?genderLabel ?freebase ?date_of_birth ?date_of_death ?taxon_rank ?taxon_rankLabel</span>
<span class="s2">{</span>
<span class="s2">  VALUES ?entity { </span><span class="si">%s</span><span class="s2"> }</span>
<span class="s2">  OPTIONAL{ ?entity wdt:P373 ?commons . }</span>
<span class="s2">  ?entity wdt:P31 ?instanceof .</span>
<span class="s2">  OPTIONAL { </span>
<span class="s2">    ?entity wdt:P18 ?_image . </span>
<span class="s2">    BIND(replace(wikibase:decodeUri(STR(?_image)),&quot; &quot;,&quot;_&quot;) AS ?image)</span>
<span class="s2">  }</span>
<span class="s2">  OPTIONAL { </span>
<span class="s2">    ?entity wdt:P41 ?_flag . </span>
<span class="s2">    BIND(replace(wikibase:decodeUri(STR(?_flag)),&quot; &quot;,&quot;_&quot;) AS ?flag)</span>
<span class="s2">  }</span>
<span class="s2">  OPTIONAL { </span>
<span class="s2">    ?entity wdt:P94 ?_coat_of_arms . </span>
<span class="s2">    BIND(replace(wikibase:decodeUri(STR(?_coat_of_arms)),&quot; &quot;,&quot;_&quot;) AS ?coat_of_arms)</span>
<span class="s2">  }</span>
<span class="s2">  OPTIONAL { </span>
<span class="s2">    ?entity wdt:P154 ?_logo . </span>
<span class="s2">    BIND(replace(wikibase:decodeUri(STR(?_logo)),&quot; &quot;,&quot;_&quot;) AS ?logo)</span>
<span class="s2">  }</span>
<span class="s2">  OPTIONAL { </span>
<span class="s2">    ?entity wdt:P2425 ?_service_ribbon . </span>
<span class="s2">    BIND(replace(wikibase:decodeUri(STR(?_service_ribbon)),&quot; &quot;,&quot;_&quot;) AS ?service_ribbon)</span>
<span class="s2">  }</span>
<span class="s2">  OPTIONAL { ?entity wdt:P21 ?gender . }</span>
<span class="s2">  OPTIONAL { ?entity wdt:P106 ?occupation . }</span>
<span class="s2">  OPTIONAL { ?entity wdt:P646 ?freebase . }</span>
<span class="s2">  OPTIONAL { ?entity wdt:P569 ?date_of_birth . }</span>
<span class="s2">  OPTIONAL { ?entity wdt:P570 ?date_of_death . }</span>
<span class="s2">  OPTIONAL { ?entity wdt:P105 ?taxon_rank . }</span>
<span class="s2">  SERVICE wikibase:label { bd:serviceParam wikibase:language &quot;en&quot;. }</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="c1"># get all feminine labels</span>
<span class="n">WIKIDATA_FEMININE_QUERY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT ?entity ?entity_female_label </span>
<span class="s2">{</span>
<span class="s2">  VALUES ?entity { </span><span class="si">%s</span><span class="s2"> }</span>
<span class="s2">  ?entity wdt:P2521 ?entity_female_label .</span>
<span class="s2">  FILTER(LANG(?entity_female_label) = &quot;en&quot;).</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># query super classes of a given class list</span>
<span class="c1"># use</span>
<span class="c1"># &gt;&gt;&gt; WIKIDATA_SUPERCLASSES_QUERY % (qids, &quot;wdt:P279+&quot;)</span>
<span class="c1"># to query all superclasses</span>
<span class="n">WIKIDATA_SUPERCLASSES_QUERY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT ?class ?classLabel ?subclassof ?subclassofLabel</span>
<span class="s2">WHERE </span>
<span class="s2">{</span>
<span class="s2">  VALUES ?class { </span><span class="si">%s</span><span class="s2"> }.</span>
<span class="s2">  ?class </span><span class="si">%s</span><span class="s2"> ?subclassof.</span>
<span class="s2">  SERVICE wikibase:label { bd:serviceParam wikibase:language &quot;en&quot;. }</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">WIKIDATA_ENDPOINT</span> <span class="o">=</span> <span class="s2">&quot;https://query.wikidata.org/sparql&quot;</span>

<span class="c1"># see update_from_data</span>
<span class="n">RESERVED_IMAGES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;logo&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;coat_of_arms&#39;</span><span class="p">,</span> <span class="s1">&#39;service_ribbon&#39;</span><span class="p">]</span>
<span class="n">MULTIPLE_KEYS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">RESERVED_IMAGES</span><span class="p">)</span>
<span class="n">UNIQUE_KEYS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;entityLabel&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;genderLabel&#39;</span><span class="p">,</span> <span class="s1">&#39;commons&#39;</span><span class="p">,</span> <span class="s1">&#39;freebase&#39;</span><span class="p">,</span> <span class="s1">&#39;date_of_birth&#39;</span><span class="p">,</span> <span class="s1">&#39;date_of_death&#39;</span><span class="p">,</span> <span class="s1">&#39;taxon_rank&#39;</span><span class="p">,</span> <span class="s1">&#39;taxon_rankLabel&#39;</span><span class="p">}</span>

<span class="c1"># template for beta-commons SPARQL API to query images that depict (P180) entities</span>
<span class="c1"># same usage as WIKIDATA_QUERY</span>
<span class="n">COMMONS_SPARQL_QUERY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT ?depicted_entity ?commons_entity ?special_path ?url ?encoding WHERE {</span>
<span class="s2">  VALUES ?depicted_entity { </span><span class="si">%s</span><span class="s2"> }</span>
<span class="s2">  ?commons_entity wdt:P180 ?depicted_entity .</span>
<span class="s2">  ?commons_entity schema:contentUrl ?url .</span>
<span class="s2">  ?commons_entity schema:encodingFormat ?encoding .</span>
<span class="s2">  # restrict media to be images handleable by PIL.Image</span>
<span class="s2">  VALUES ?encoding { &quot;image/png&quot; &quot;image/jpg&quot; &quot;image/jpeg&quot; &quot;image/tiff&quot; &quot;image/gif&quot; }</span>
<span class="s2">  bind(iri(concat(&quot;http://commons.wikimedia.org/wiki/Special:FilePath/&quot;, wikibase:decodeUri(substr(str(?url),53)))) AS ?special_path)</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="c1"># query entities depicted in images given image identifier (see above for more details)</span>
<span class="n">COMMONS_DEPICTED_ENTITIES_QUERY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT ?commons_entity ?depicted_entity WHERE {</span>
<span class="s2">  VALUES ?commons_entity { </span><span class="si">%s</span><span class="s2"> }</span>
<span class="s2">  ?commons_entity wdt:P180 ?depicted_entity .</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">COMMONS_SPARQL_ENDPOINT</span> <span class="o">=</span> <span class="s2">&quot;https://wcqs-beta.wmflabs.org/sparql&quot;</span>

<span class="c1"># get all files or sub-categories in a Commons category</span>
<span class="c1"># use like</span>
<span class="c1"># &gt;&gt;&gt; COMMONS_REST_LIST.format(cmtitle=&lt;str including &quot;Category:&quot; prefix&gt;, cmtype=&quot;subcat&quot;|&quot;file&quot;)</span>
<span class="c1"># e.g.</span>
<span class="c1"># &gt;&gt;&gt; COMMONS_REST_LIST.format(cmtitle=&quot;Category:Barack Obama in 2004&quot;, cmtype=&quot;subcat&quot;)</span>
<span class="n">COMMONS_REST_LIST</span> <span class="o">=</span> <span class="s2">&quot;https://commons.wikimedia.org/w/api.php?action=query&amp;list=categorymembers&amp;cmtitle=</span><span class="si">{cmtitle}</span><span class="s2">&amp;cmprop=title|type&amp;format=json&amp;cmcontinue&amp;cmlimit=max&amp;cmtype=</span><span class="si">{cmtype}</span><span class="s2">&quot;</span>

<span class="c1"># query images URL, categories and description</span>
<span class="c1"># use like</span>
<span class="c1"># &gt;&gt;&gt; COMMONS_REST_TITLE.format(titles=&lt;title1&gt;|&lt;title2&gt;) including the &quot;File:&quot; prefix</span>
<span class="c1"># e.g.</span>
<span class="c1"># &gt;&gt;&gt; COMMONS_REST_TITLE.format(titles=&quot;File:Barack Obama foreign trips.png|File:Women for Obama luncheon September 23, 2004.png&quot;)</span>
<span class="n">COMMONS_REST_TITLE</span> <span class="o">=</span> <span class="s2">&quot;https://commons.wikimedia.org/w/api.php?action=query&amp;titles=</span><span class="si">{titles}</span><span class="s2">&amp;prop=categories|description|imageinfo&amp;format=json&amp;iiprop=url|extmetadata&amp;clshow=!hidden&quot;</span>

<span class="n">VALID_IMAGE_HEURISTICS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;categories&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;depictions&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="file_name_to_thumbnail"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.file_name_to_thumbnail">[docs]</a><span class="k">def</span> <span class="nf">file_name_to_thumbnail</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">image_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get upload.wikimedia.org url from image file_name using the desired thumbnail width</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_name: str</span>
<span class="sd">        file name/title (without the &quot;File:&quot; prefix)</span>
<span class="sd">    image_width: int, optional</span>
<span class="sd">        desired thumbnail width in pixels for the image url</span>
<span class="sd">        Defaults to full-size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">file_hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">image_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thumb</span><span class="p">,</span> <span class="n">sized_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="s2">&quot;thumb/&quot;</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">EXTENSIONS_PRE_AND_SUFFIXES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">sized_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">image_width</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">px-</span><span class="si">{</span><span class="n">file_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">UPLOAD_URI_PREFIX</span><span class="si">}{</span><span class="n">thumb</span><span class="si">}{</span><span class="n">file_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_hash</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}{</span><span class="n">sized_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="thumbnail_to_file_name"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.thumbnail_to_file_name">[docs]</a><span class="k">def</span> <span class="nf">thumbnail_to_file_name</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles thumbnails and special file paths</span>

<span class="sd">    If original (default), Returns the original file-name, i.e. with the original extension and without any size specification introduced in file_name_to_thumbnail</span>

<span class="sd">    e.g. &quot;https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/foo.tif/lossy-page1-469px-foo.tif.jpg&quot; -&gt; &quot;foo.tif&quot;</span>

<span class="sd">    else, the file name is returned as processed in file_name_to_thumbnail, i.e. with size specification etc.</span>
<span class="sd">    e.g. &quot;https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/foo.tif/lossy-page1-469px-foo.tif.jpg&quot; -&gt; &quot;lossy-page1-469px-foo.tif.jpg&quot;</span>

<span class="sd">    This is irrelevant of course if the url is not a thumbnail</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">SPECIAL_FILE_PATH_URI_PREFIX</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_FILE_PATH_URI_PREFIX</span><span class="p">):]</span>
    <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">SPECIAL_PATH_URI_PREFIX</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_PATH_URI_PREFIX</span><span class="p">):]</span>
    <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">UPLOAD_URI_PREFIX</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">UPLOAD_URI_PREFIX</span><span class="p">):]</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;thumb/&#39;</span><span class="p">):</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;thumb/a/a8/&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">original</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">file_name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file_name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;a/a8/&#39;</span><span class="p">):]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="bytes2dict"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.bytes2dict">[docs]</a><span class="k">def</span> <span class="nf">bytes2dict</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_license"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.get_license">[docs]</a><span class="k">def</span> <span class="nf">get_license</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get license short-name, upper-cased. Returns empty-string (&#39;&#39;) if unavailable&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extmetadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LicenseShortName&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span></div>


<div class="viewcode-block" id="license_score"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.license_score">[docs]</a><span class="k">def</span> <span class="nf">license_score</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets license value, normalize it and return score (in LICENSES)&quot;&quot;&quot;</span>
    <span class="n">license_</span> <span class="o">=</span> <span class="n">get_license</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># look for the kind of CC license (handles dashes)</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CC[ -](BY\S*)[ -]\d\.\d&quot;</span><span class="p">,</span> <span class="n">license_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">license_</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">LICENSES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">license_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_sparql_entities"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.query_sparql_entities">[docs]</a><span class="k">def</span> <span class="nf">query_sparql_entities</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">wikidata_ids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;wd:&#39;</span><span class="p">,</span>
                          <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">return_format</span><span class="o">=</span><span class="n">JSON</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries query%entities by batch of n (defaults 100)</span>
<span class="sd">    where entities is n QIDs in wikidata_ids space-separated and prefixed by prefix</span>
<span class="sd">    (should be &#39;wd:&#39; for Wikidata entities and &#39;sdc:&#39; for Commons entities)</span>

<span class="sd">    Returns query results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sparql</span> <span class="o">=</span> <span class="n">SPARQLWrapper</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
    <span class="n">sparql</span><span class="o">.</span><span class="n">setReturnFormat</span><span class="p">(</span><span class="n">return_format</span><span class="p">)</span>
    <span class="n">sparql</span><span class="o">.</span><span class="n">setUseKeepAlive</span><span class="p">()</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">qids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">skip_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># query only n qid at a time</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">wikidata_ids</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">description</span><span class="p">)):</span>
        <span class="n">qids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="n">qid</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wikidata_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sparql</span><span class="o">.</span><span class="n">setQuery</span><span class="p">(</span><span class="n">query</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qids</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">sparql</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;429&#39;</span><span class="p">:</span>
                    <span class="c1"># HACK: sleep WIKIDATA_COMPUTE_LIMIT seconds to avoid &#39;HTTP Error 429: Too Many Requests&#39;</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">WIKIDATA_COMPUTE_LIMIT</span><span class="p">)</span>
                    <span class="c1"># try one more time</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">sparql</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTTPError: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;Query failed twice after waiting </span><span class="si">{</span><span class="n">WIKIDATA_COMPUTE_LIMIT</span><span class="si">}</span><span class="s2">s in-between, &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;skipping the following QIDs:</span><span class="se">\n</span><span class="si">{</span><span class="n">qids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">skip_total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qids</span><span class="p">)</span>
                        <span class="n">qids</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTTPError: </span><span class="si">{</span><span class="n">e1</span><span class="si">}</span><span class="se">\n</span><span class="s2">skipping the following QIDs:</span><span class="se">\n</span><span class="si">{</span><span class="n">qids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">skip_total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qids</span><span class="p">)</span>
                    <span class="n">qids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>
            <span class="n">results</span> <span class="o">+=</span> <span class="n">response</span><span class="o">.</span><span class="n">convert</span><span class="p">()[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;bindings&#39;</span><span class="p">]</span>
            <span class="n">qids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query succeeded! Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results, skipped </span><span class="si">{</span><span class="n">skip_total</span><span class="si">}</span><span class="s2"> QIDs&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="update_from_data"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.update_from_data">[docs]</a><span class="k">def</span> <span class="nf">update_from_data</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates entities with info queried in from Wikidata&quot;&quot;&quot;</span>

    <span class="c1"># query Wikidata</span>
    <span class="k">if</span> <span class="n">skip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wikidata_ids</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="c1"># skip all entities that already have the `skip` attribute</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wikidata_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">qid</span> <span class="k">for</span> <span class="n">qid</span> <span class="ow">in</span> <span class="n">entities</span> <span class="k">if</span> <span class="n">skip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">query_sparql_entities</span><span class="p">(</span><span class="n">WIKIDATA_QUERY</span><span class="p">,</span> <span class="n">WIKIDATA_ENDPOINT</span><span class="p">,</span> <span class="n">wikidata_ids</span><span class="p">,</span>
                                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Querying Wikidata&quot;</span><span class="p">)</span>
    <span class="c1"># update entities with results</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Updating entities&quot;</span><span class="p">):</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># handle keys/attributes that are unique</span>
        <span class="k">for</span> <span class="n">unique_key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">UNIQUE_KEYS</span> <span class="o">&amp;</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># simply add or update the key/attribute</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">][</span><span class="n">unique_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">unique_key</span><span class="p">]</span>
        <span class="c1"># handle keys/attributes that may be multiple</span>
        <span class="k">for</span> <span class="n">multiple_key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">MULTIPLE_KEYS</span> <span class="o">&amp;</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># create a new dict for this key/attribute so we don&#39;t duplicate data</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">multiple_key</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># store corresponding label in the &#39;label&#39; field</span>
            <span class="n">result</span><span class="p">[</span><span class="n">multiple_key</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">multiple_key</span> <span class="o">+</span> <span class="s1">&#39;Label&#39;</span><span class="p">)</span>
            <span class="c1"># value (e.g. QID) of the attribute serves as key</span>
            <span class="n">multiple_value</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">multiple_key</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">][</span><span class="n">multiple_key</span><span class="p">][</span><span class="n">multiple_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">multiple_key</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="set_reference_images"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.set_reference_images">[docs]</a><span class="k">def</span> <span class="nf">set_reference_images</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set a reference image using RESERVED_IMAGES as order of preference if the entity has any available&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># try to get illustrative image, fallback on other images if available</span>
        <span class="c1"># &quot;image&quot; is expected to be the first element of RESERVED_IMAGES</span>
        <span class="k">for</span> <span class="n">entity_image_key</span> <span class="ow">in</span> <span class="n">RESERVED_IMAGES</span><span class="p">:</span>
            <span class="n">entity_image</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity_image_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># HACK: pop &#39;type&#39; and &#39;value&#39; that might have been gathered</span>
                <span class="c1"># when we considered only a single illustrative image per entity</span>
                <span class="n">entity_image</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">entity_image</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># filter encodings</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">entity_image</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">encoding</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="n">VALID_ENCODING</span><span class="p">:</span>
                        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;reference_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="n">VALID_ENCODING</span><span class="p">:</span>
                    <span class="k">break</span>
            
    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="update_from_commons_sparql"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.update_from_commons_sparql">[docs]</a><span class="k">def</span> <span class="nf">update_from_commons_sparql</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="c1"># query Wikimedia Commons</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">query_sparql_entities</span><span class="p">(</span><span class="n">COMMONS_SPARQL_QUERY</span><span class="p">,</span> <span class="n">COMMONS_SPARQL_ENDPOINT</span><span class="p">,</span>
                                    <span class="n">entities</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Querying Wikimedia Commons&quot;</span><span class="p">)</span>

    <span class="c1"># update entities with results</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Updating entities&quot;</span><span class="p">):</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;depicted_entity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">commons_qid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;commons_entity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="c1"># create a new key &#39;depictions&#39; to store depictions in a dict</span>
        <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;depictions&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># use commons_qid (e.g. https://commons.wikimedia.org/entity/M88412327) as key in this dict</span>
        <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">][</span><span class="s2">&quot;depictions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">commons_qid</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">][</span><span class="s2">&quot;depictions&quot;</span><span class="p">][</span><span class="n">commons_qid</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
        <span class="n">entities</span><span class="p">[</span><span class="n">qid</span><span class="p">][</span><span class="s2">&quot;depictions&quot;</span><span class="p">][</span><span class="n">commons_qid</span><span class="p">][</span><span class="s1">&#39;special_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;special_path&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="query_depicted_entities"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.query_depicted_entities">[docs]</a><span class="k">def</span> <span class="nf">query_depicted_entities</span><span class="p">(</span><span class="n">depictions</span><span class="p">):</span>
    <span class="c1"># query Wikimedia Commons</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">query_sparql_entities</span><span class="p">(</span><span class="n">COMMONS_DEPICTED_ENTITIES_QUERY</span><span class="p">,</span>
                                    <span class="n">COMMONS_SPARQL_ENDPOINT</span><span class="p">,</span>
                                    <span class="n">depictions</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;sdc:&quot;</span><span class="p">,</span>
                                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Querying Wikimedia Commons&quot;</span><span class="p">)</span>
    <span class="c1"># update depictions with results</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Updating depictions&quot;</span><span class="p">):</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;commons_entity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">depictions</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;depicted_entity&quot;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">depictions</span></div>


<div class="viewcode-block" id="depiction_instanceof_heuristic"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.depiction_instanceof_heuristic">[docs]</a><span class="k">def</span> <span class="nf">depiction_instanceof_heuristic</span><span class="p">(</span><span class="n">depictions</span><span class="p">,</span> <span class="n">entities</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Applying &#39;instanceof&#39; heuristic&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;instanceof&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">instanceof</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;instanceof&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">entity_depictions</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depictions&quot;</span><span class="p">,</span> <span class="p">{})</span>    
        <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">depiction</span> <span class="ow">in</span> <span class="n">entity_depictions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="n">mid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">depiction</span><span class="p">[</span><span class="s2">&quot;prominent_instanceof_heuristic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># iterate over all other entities depicted in depiction</span>
            <span class="k">for</span> <span class="n">other_qid</span> <span class="ow">in</span> <span class="n">depictions</span><span class="p">[</span><span class="n">mid</span><span class="p">]:</span>
                <span class="n">other_qid</span> <span class="o">=</span> <span class="n">other_qid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># skip self</span>
                <span class="k">if</span> <span class="n">other_qid</span> <span class="o">==</span> <span class="n">qid</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">other_entity</span> <span class="o">=</span> <span class="n">entities</span><span class="p">[</span><span class="n">other_qid</span><span class="p">]</span>
                <span class="n">other_instanceof</span> <span class="o">=</span> <span class="n">other_entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="c1"># heuristic: the depiction is prominent if the entity is the only one of the same instance</span>
                <span class="c1"># e.g. pic of Barack Obama and Joe Biden -&gt; not prominent</span>
                <span class="c1">#      pic of Barack Obama and the Eiffel Tower -&gt; prominent</span>
                <span class="k">if</span> <span class="n">instanceof</span> <span class="o">&amp;</span> <span class="n">other_instanceof</span><span class="p">:</span>
                    <span class="n">depiction</span><span class="p">[</span><span class="s2">&quot;prominent_instanceof_heuristic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="keep_prominent_depictions"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.keep_prominent_depictions">[docs]</a><span class="k">def</span> <span class="nf">keep_prominent_depictions</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">depictions</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depictions&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">depictions</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># filter out non-prominent depictions</span>
        <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;depictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">mid</span><span class="p">:</span> <span class="n">depiction</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">depiction</span> <span class="ow">in</span> <span class="n">depictions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">depiction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prominent_instanceof_heuristic&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="request"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.request">[docs]</a><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GET query via requests, handles exceptions and returns None if something went wrong&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Something went wrong when requesting for &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">max_tries</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_msg</span><span class="si">}</span><span class="s2">Maximum number of tries (</span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2">) exceeded: </span><span class="si">{</span><span class="n">tries</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="s1">&#39;meerqat bot 0.1&#39;</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_msg</span><span class="si">}</span><span class="s2">requests.exceptions.ConnectionError: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">MaxRetryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_msg</span><span class="si">}</span><span class="s2">MaxRetryError: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_msg</span><span class="si">}</span><span class="s2">OSError: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_msg</span><span class="si">}</span><span class="s2">Exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">request</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tries</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="n">max_tries</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_msg</span><span class="si">}</span><span class="s2">status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="query_commons_subcategories"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.query_commons_subcategories">[docs]</a><span class="k">def</span> <span class="nf">query_commons_subcategories</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>
                                <span class="n">max_images</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_categories</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                <span class="n">n_queried_categories</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Query all commons subcategories (and optionally images) from a root category recursively</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    category: str</span>
<span class="sd">        Root category</span>
<span class="sd">    categories: dict</span>
<span class="sd">        {str: bool}, True if the category has been processed</span>
<span class="sd">    images: dict</span>
<span class="sd">        {str: dict}, Key is the file title, gathers data about the image, see query_image</span>
<span class="sd">    max_images: int, optional</span>
<span class="sd">        Maximum number of images to query per entity/root category.</span>
<span class="sd">        Set to 0 if you only want to query categories (images dict will be left empty)</span>
<span class="sd">        Defaults to 1000</span>
<span class="sd">    max_categories: int, optional</span>
<span class="sd">        Maximum number of categories to query per entity/root category.</span>
<span class="sd">        Enforced via:</span>
<span class="sd">        - n_queried_categories if max_images &gt; 0</span>
<span class="sd">        - len(categories) otherwise</span>
<span class="sd">        Defaults to 100</span>
<span class="sd">    n_queried_categories: int, optional</span>
<span class="sd">        Keeps track of the number of queried categories in order to enforce max_categories</span>
<span class="sd">        Should be equal to the number of True in categories</span>
<span class="sd">        Defaults to 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    categories, images: dict</span>
<span class="sd">        Same as input, hopefully enriched with new data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">COMMONS_REST_LIST</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmtitle</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">cmtype</span><span class="o">=</span><span class="s2">&quot;subcat|file&quot;</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">bytes2dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;categorymembers&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span>

    <span class="c1"># recursive call: query subcategories of the subcategories</span>
    <span class="n">categories</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">n_queried_categories</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="c1"># first query all files in the category before querying subcategories</span>
        <span class="c1"># except if max_images &lt;= 0, then only query subcategories</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span> <span class="ow">and</span> <span class="n">max_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># avoid querying the same image again and again as the same image is often in multiple categories</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_ENCODING</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">images</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_image</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;subcat&quot;</span><span class="p">:</span>
            <span class="c1"># avoid 1. to get stuck in a loop 2. extra processing:</span>
            <span class="c1"># skip already processed categories</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="c1"># and keep track of the processed categories</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># return when we have enough images or categories</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_images</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">max_images</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_queried_categories</span> <span class="o">&gt;</span> <span class="n">max_categories</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">max_images</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_categories</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span>
    <span class="c1"># else query all subcategories</span>
    <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
        <span class="n">query_commons_subcategories</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>
                                    <span class="n">max_images</span><span class="o">=</span><span class="n">max_images</span><span class="p">,</span>
                                    <span class="n">max_categories</span><span class="o">=</span><span class="n">max_categories</span><span class="p">,</span>
                                    <span class="n">n_queried_categories</span><span class="o">=</span><span class="n">n_queried_categories</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span></div>


<div class="viewcode-block" id="query_image"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.query_image">[docs]</a><span class="k">def</span> <span class="nf">query_image</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="c1"># query images URL, categories and description</span>
    <span class="c1"># note: it might be better to batch the query but when experimenting with</span>
    <span class="c1"># batch size as low as 25 I had to deal with &#39;continue&#39; responses...</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">COMMONS_REST_TITLE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">titles</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">bytes2dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;pages&#39;</span><span class="p">]</span>
    <span class="c1"># get first (only) value</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">imageinfo</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imageinfo&#39;</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">image_categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;categories&#39;</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="c1"># filter metadata</span>
    <span class="n">extmetadata</span> <span class="o">=</span> <span class="n">imageinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extmetadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">extmetadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Categories&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># TODO add some preference rules according to extmetadata[&quot;LicenseShortName&quot;]</span>
    <span class="c1"># not sure how the description of an image is metadata but anyway, I fount it there...</span>
    <span class="n">imageDescription</span> <span class="o">=</span> <span class="n">extmetadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ImageDescription&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">image</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">image_categories</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">imageinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">imageDescription</span><span class="p">,</span>
        <span class="s2">&quot;extmetadata&quot;</span><span class="p">:</span> <span class="n">extmetadata</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="save_image"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.save_image">[docs]</a><span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">thumbnail_to_file_name</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">COMMONS_PATH</span> <span class="o">/</span> <span class="n">file_name</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Dr._Paul_R._Heyl,_Scientists_for_Uncle_Sam_awarded_Magellan_Gold_Medal._Dr._L.J._Briggs,_left,_Assistant_Director_and_Dr._Paul_R._Heyl,_Chief_of_the_Sound_Section_of_the_United_States_Bureau_of_Standards,_LCCN2016888398_(cropped).tiff&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># request image</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;:/&#39;</span><span class="p">),</span> <span class="n">session</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># save if request went OK</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image_path</span></div>


<div class="viewcode-block" id="update_from_commons_rest"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.update_from_commons_rest">[docs]</a><span class="k">def</span> <span class="nf">update_from_commons_rest</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_categories</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">n_images</span><span class="p">,</span> <span class="n">n_categories</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Updating entities from Commons&quot;</span><span class="p">):</span>
        <span class="c1"># query only entities that appear in dataset (some may come from &#39;depictions&#39;)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;n_questions&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s2">&quot;commons&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">category</span> <span class="o">=</span> <span class="s2">&quot;Category:&quot;</span> <span class="o">+</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;commons&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="c1"># query all images in of entity Commons category and subcategories recursively</span>
        <span class="n">categories</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">query_commons_subcategories</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">max_images</span><span class="p">,</span> <span class="n">max_categories</span><span class="p">)</span>
        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span>
        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span>
        <span class="n">n_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">))</span>
        <span class="n">n_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">n_images</span><span class="p">)</span><span class="si">}</span><span class="s2"> entities out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2"> have a root Commons Category and questions in the dataset</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Retrieved images:</span><span class="se">\n</span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">n_images</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">and categories:</span><span class="se">\n</span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">n_categories</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="special_path_to_file_name"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.special_path_to_file_name">[docs]</a><span class="k">def</span> <span class="nf">special_path_to_file_name</span><span class="p">(</span><span class="n">special_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;split url, add &quot;File:&quot; prefix and replace underscores with spaces&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;File:&quot;</span><span class="o">+</span><span class="n">special_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="image_heuristic"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.image_heuristic">[docs]</a><span class="k">def</span> <span class="nf">image_heuristic</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">heuristics</span><span class="o">=</span><span class="n">VALID_IMAGE_HEURISTICS</span><span class="p">):</span>
    <span class="n">invalid_heuristics</span> <span class="o">=</span> <span class="n">VALID_IMAGE_HEURISTICS</span> <span class="o">-</span> <span class="n">heuristics</span>
    <span class="k">if</span> <span class="n">invalid_heuristics</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No heuristic was implemented for </span><span class="si">{</span><span class="n">invalid_heuristics</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;Use one of </span><span class="si">{</span><span class="n">VALID_IMAGE_HEURISTICS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># TODO named entity/link in description heuristic</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">best_scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Applying heuristics&quot;</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entityLabel&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="ow">or</span> <span class="s1">&#39;images&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># get file names of the depictions (add &quot;File:&quot; prefix and replace underscores with spaces)</span>
        <span class="k">if</span> <span class="s2">&quot;depictions&quot;</span> <span class="ow">in</span> <span class="n">heuristics</span><span class="p">:</span>
            <span class="n">depictions</span> <span class="o">=</span> <span class="p">{</span><span class="n">special_path_to_file_name</span><span class="p">(</span><span class="n">depiction</span><span class="p">[</span><span class="s2">&quot;special_path&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">depiction</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depictions&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">image</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;heuristics&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="c1"># entity label should be included in all of the images categories</span>
            <span class="k">if</span> <span class="s2">&quot;categories&quot;</span> <span class="ow">in</span> <span class="n">heuristics</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">):</span>
                <span class="n">included</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">included</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">included</span><span class="p">:</span>
                    <span class="n">image</span><span class="p">[</span><span class="s2">&quot;heuristics&quot;</span><span class="p">][</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># entity label should be included in the description</span>
            <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">heuristics</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">image</span><span class="p">[</span><span class="s2">&quot;heuristics&quot;</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># image should be tagged as depicting (P180) the entity on Commons</span>
            <span class="k">if</span> <span class="s2">&quot;depictions&quot;</span> <span class="ow">in</span> <span class="n">heuristics</span> <span class="ow">and</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">depictions</span><span class="p">:</span>
                <span class="n">image</span><span class="p">[</span><span class="s2">&quot;heuristics&quot;</span><span class="p">][</span><span class="s2">&quot;depictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># entity label should be included in the image title</span>
            <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">in</span> <span class="n">heuristics</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">image</span><span class="p">[</span><span class="s2">&quot;heuristics&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s2">&quot;heuristics&quot;</span><span class="p">])</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
        <span class="n">best_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_score</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied heuristics </span><span class="si">{</span><span class="n">heuristics</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2"> entities/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">}</span><span class="s2"> images</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Entity-level best scores stats:</span><span class="se">\n</span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">best_scores</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Image-level scores stats:</span><span class="se">\n</span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="exclude_classes"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.exclude_classes">[docs]</a><span class="k">def</span> <span class="nf">exclude_classes</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">classes_to_exclude</span><span class="p">,</span> <span class="n">superclasses</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">filtered_entities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Filtering entities classes&quot;</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c1"># class should be excluded</span>
        <span class="k">if</span> <span class="n">classes</span> <span class="o">&amp;</span> <span class="n">classes_to_exclude</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">exclude_super_class</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="c1"># superclass should be excluded</span>
            <span class="k">if</span> <span class="n">superclasses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">classes_to_exclude</span><span class="p">:</span>
                <span class="n">exclude_super_class</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">exclude_super_class</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># else keep entity/class</span>
        <span class="n">filtered_entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filtered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2"> entities to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_entities</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_entities</span></div>


<div class="viewcode-block" id="keep_classes"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.keep_classes">[docs]</a><span class="k">def</span> <span class="nf">keep_classes</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">classes_to_keep</span><span class="p">,</span> <span class="n">superclasses</span><span class="o">=</span><span class="p">{},</span> <span class="n">attributes_to_keep</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span> <span class="s2">&quot;occupation&quot;</span><span class="p">}):</span>
    <span class="n">filtered_entities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Filtering entities classes&quot;</span><span class="p">):</span>
        <span class="c1"># keep all entities with an attribute in attributes_to_keep</span>
        <span class="n">has_attribute</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes_to_keep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">):</span>
                <span class="n">has_attribute</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">has_attribute</span><span class="p">:</span>
            <span class="n">filtered_entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="k">continue</span>

        <span class="c1"># else keep entities with appropriate class or superclass</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c1"># class should be kept</span>
        <span class="k">if</span> <span class="n">classes</span> <span class="o">&amp;</span> <span class="n">classes_to_keep</span><span class="p">:</span>
            <span class="n">filtered_entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="c1"># superclass should be kept</span>
            <span class="k">if</span> <span class="n">superclasses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">classes_to_keep</span><span class="p">:</span>
                <span class="n">filtered_entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
                <span class="k">break</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filtered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2"> entities to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_entities</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_entities</span></div>


<div class="viewcode-block" id="iso2year"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.iso2year">[docs]</a><span class="k">def</span> <span class="nf">iso2year</span><span class="p">(</span><span class="n">iso</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles negative dates&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">iso</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">iso</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">year</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span><span class="o">.</span><span class="n">year</span></div>


<div class="viewcode-block" id="remove_alive_humans"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.remove_alive_humans">[docs]</a><span class="k">def</span> <span class="nf">remove_alive_humans</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">year_threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)):</span>
    <span class="n">filtered_entities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Removing alive humans&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">HUMAN</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">date_of_death</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_of_death&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">date_of_death</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VALID_DATE_TYPE</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">year_of_death</span> <span class="o">=</span> <span class="n">iso2year</span><span class="p">(</span><span class="n">date_of_death</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">year_of_death</span> <span class="o">&gt;</span> <span class="n">year_threshold</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">filtered_entities</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filtered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2"> entities to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_entities</span><span class="p">)</span><span class="si">}</span><span class="s2"> using year_threshold=</span><span class="si">{</span><span class="n">year_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_entities</span></div>


<div class="viewcode-block" id="query_superclasses"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.query_superclasses">[docs]</a><span class="k">def</span> <span class="nf">query_superclasses</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">wikidata_superclasses_query</span><span class="p">,</span> <span class="n">n_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n_levels</span><span class="p">:</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">):</span>
            <span class="n">level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;wdt:P279&quot;</span><span class="p">)</span>
            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="s2">&quot;wdt:P279+&quot;</span>

    <span class="n">wikidata_superclasses_query</span> <span class="o">=</span> <span class="n">wikidata_superclasses_query</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
    <span class="c1"># get all &#39;instanceof&#39; i.e. all classes</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="n">qid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">class_</span>
               <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
               <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1"># query all &#39;subclassof&#39; i.e. all superclasses</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">query_sparql_entities</span><span class="p">(</span><span class="n">wikidata_superclasses_query</span><span class="p">,</span> <span class="n">WIKIDATA_ENDPOINT</span><span class="p">,</span>
                                    <span class="n">classes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Querying superclasses&quot;</span><span class="p">)</span>
    <span class="n">superclasses</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">qid_uri</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">superclasses</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">qid_uri</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">subclassof</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;subclassof&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;subclassof&quot;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;subclassofLabel&quot;</span><span class="p">]</span>
        <span class="n">superclasses</span><span class="p">[</span><span class="n">qid_uri</span><span class="p">][</span><span class="n">subclassof</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;subclassof&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">superclasses</span></div>


<div class="viewcode-block" id="uri_to_qid"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.uri_to_qid">[docs]</a><span class="k">def</span> <span class="nf">uri_to_qid</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="uris_to_qids"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.uris_to_qids">[docs]</a><span class="k">def</span> <span class="nf">uris_to_qids</span><span class="p">(</span><span class="n">uris</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">uri_to_qid</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">uris</span><span class="p">}</span></div>


<div class="viewcode-block" id="query_feminine_labels"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.query_feminine_labels">[docs]</a><span class="k">def</span> <span class="nf">query_feminine_labels</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="c1"># 1. get all classes and occupations</span>
    <span class="n">qids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">qids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uris_to_qids</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instanceof&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">qids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uris_to_qids</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;occupation&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1"># 2. query feminine labels of qids</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">query_sparql_entities</span><span class="p">(</span><span class="n">WIKIDATA_FEMININE_QUERY</span><span class="p">,</span> <span class="n">WIKIDATA_ENDPOINT</span><span class="p">,</span>
                                    <span class="n">qids</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Querying feminine labels&quot;</span><span class="p">)</span>
    <span class="n">feminine_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">feminine_label</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entity_female_label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">feminine_labels</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">feminine_label</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feminine_labels</span></div>


<div class="viewcode-block" id="stats"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.stats">[docs]</a><span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simply count the # of field for every entity&quot;&quot;&quot;</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">counter</span></div>


<div class="viewcode-block" id="print_stats"><a class="viewcode-back" href="../../../meerqat.data.wiki.html#meerqat.data.wiki.print_stats">[docs]</a><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">stats</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([</span><span class="n">counter</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;latex&#39;</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># parse arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;subset&gt;&#39;</span><span class="p">]</span>

    <span class="c1"># load entities</span>
    <span class="n">subset_path</span> <span class="o">=</span> <span class="n">DATA_ROOT_PATH</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;meerqat_</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">subset_path</span> <span class="o">/</span> <span class="s2">&quot;entities.json&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">depictions_path</span> <span class="o">=</span> <span class="n">subset_path</span> <span class="o">/</span> <span class="s2">&quot;depictions.json&quot;</span>

    <span class="c1"># update from Wikidata or Wikimedia Commons</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;entities&#39;</span><span class="p">]:</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">update_from_data</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--skip&quot;</span><span class="p">])</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">set_reference_images</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
            <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;feminine&#39;</span><span class="p">]:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">query_feminine_labels</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">subset_path</span><span class="o">/</span><span class="s2">&quot;feminine_labels.json&quot;</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;depicted&#39;</span><span class="p">]:</span>
            <span class="c1"># load depictions</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">depictions_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">depictions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">depicted_entities</span> <span class="o">=</span> <span class="p">{</span><span class="n">qid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="p">{</span><span class="s2">&quot;n_questions&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span> 
                                 <span class="k">for</span> <span class="n">depiction</span> <span class="ow">in</span> <span class="n">depictions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
                                 <span class="k">for</span> <span class="n">qid</span> <span class="ow">in</span> <span class="n">depiction</span><span class="p">}</span>
            <span class="c1"># query data about all depicted entities</span>
            <span class="n">depicted_entities</span> <span class="o">=</span> <span class="n">update_from_data</span><span class="p">(</span><span class="n">depicted_entities</span><span class="p">)</span>
            <span class="c1"># update with the original entities data</span>
            <span class="n">depicted_entities</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
            <span class="c1"># apply &quot;instance of&quot; heuristic to tell if a depiction is prominent or not</span>
            <span class="c1"># note the result is saved in &#39;entities&#39; as it is entity-dependent</span>
            <span class="c1"># (the same picture can be prominent for entity A but not for B and C)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">depiction_instanceof_heuristic</span><span class="p">(</span><span class="n">depictions</span><span class="p">,</span> <span class="n">depicted_entities</span><span class="p">)</span>
            <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;superclasses&#39;</span><span class="p">]:</span>
            <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;--n&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--n&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">query_superclasses</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">WIKIDATA_SUPERCLASSES_QUERY</span><span class="p">,</span> <span class="n">n_levels</span><span class="o">=</span><span class="n">n_levels</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">subset_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_levels</span> <span class="k">if</span> <span class="n">n_levels</span> <span class="k">else</span> <span class="s1">&#39;all&#39;</span><span class="si">}</span><span class="s2">_superclasses.json&quot;</span>

    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;commons&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sparql&#39;</span><span class="p">]:</span>
            <span class="c1"># find images that depict the entities</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;depicts&#39;</span><span class="p">]:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">update_from_commons_sparql</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
                <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

            <span class="c1"># find entities depicted in the images</span>
            <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;depicted&#39;</span><span class="p">]:</span>
                <span class="c1"># get depictions</span>
                <span class="n">depictions</span> <span class="o">=</span> <span class="p">{</span><span class="n">depiction</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="p">[]</span>
                              <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                              <span class="k">for</span> <span class="n">depiction</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depictions&quot;</span><span class="p">,</span> <span class="p">{})}</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">query_depicted_entities</span><span class="p">(</span><span class="n">depictions</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">depictions_path</span>
                <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;rest&#39;</span><span class="p">]:</span>
            <span class="n">max_images</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;--max_images&#39;</span><span class="p">])</span>
            <span class="n">max_categories</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;--max_categories&#39;</span><span class="p">])</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">update_from_commons_rest</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">max_images</span><span class="p">,</span> <span class="n">max_categories</span><span class="p">)</span>
            <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;heuristics&#39;</span><span class="p">]:</span>
            <span class="n">heuristics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;heuristic&gt;&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;heuristic&gt;&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">VALID_IMAGE_HEURISTICS</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">image_heuristic</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">heuristics</span><span class="p">)</span>
            <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]:</span>
        <span class="n">positive_filter</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--positive&#39;</span><span class="p">]</span>
        <span class="n">negative_filter</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--negative&#39;</span><span class="p">]</span>
        <span class="n">deceased</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;--deceased&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--deceased&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">superclass_level</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--superclass&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">superclass_level</span> <span class="ow">and</span> <span class="n">superclass_level</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">superclass_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">superclass_level</span><span class="p">)</span>
        <span class="n">classes_to_exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">QID_URI_PREFIX</span> <span class="o">+</span> <span class="n">qid</span> <span class="k">for</span> <span class="n">qid</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;classes_to_exclude&gt;&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">superclass_level</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">subset_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">superclass_level</span><span class="si">}</span><span class="s2">_superclasses.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">superclasses</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">superclasses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">positive_filter</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DATA_ROOT_PATH</span> <span class="o">/</span> <span class="s2">&quot;concrete_entities.csv&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">classes_to_keep</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">keep_classes</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">classes_to_keep</span><span class="p">,</span> <span class="n">superclasses</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">negative_filter</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DATA_ROOT_PATH</span> <span class="o">/</span> <span class="s2">&quot;abstract_entities.csv&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">abstract_entities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">classes_to_exclude</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">abstract_entities</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">classes_to_exclude</span><span class="p">:</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">exclude_classes</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">classes_to_exclude</span><span class="p">,</span> <span class="n">superclasses</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deceased</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">remove_alive_humans</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">year_threshold</span><span class="o">=</span><span class="n">deceased</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">entities</span>
        <span class="n">print_stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="c1"># save output</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully saved output to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, CNRS.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.1.1.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>